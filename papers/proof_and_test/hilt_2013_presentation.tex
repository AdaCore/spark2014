\documentclass{beamer}
\input{altran-beamer}
\usepackage{listings}
\usepackage{setspace}
\usepackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{shadows}

\lstdefinestyle{tinystyle} {basicstyle=\scriptsize\tt,
  keywordstyle=\bf, commentstyle=\rmfamily\it, escapeinside={(*}{*)}}
\lstset{style=tinystyle}

\lstdefinelanguage{SPARK}{ language = [95]Ada, morekeywords = {pre,
    post, assert, assume, check, derives, hide, global, inherit, from,
    own, initializes, main_program, input, output, in_out,
    refined_pre, refined_post, some, depends}, comment=[l][commentstyle]{--\ },
  showstringspaces=false }

\lstset{language=SPARK}

\title{Optimising Verification Effort\\with SPARK 2014}
\author{Andrew Hawthorn}
\hypersetup{colorlinks=true}
\begin{document}

\begin{altrantitle}
  \titleprismlabela{Formally Specify}
  \titleprismlabelb{Test and Prove}
  \titleprismlabelc{Reduce Cost}
\end{altrantitle}

%\begin{frame}[fragile]{Contents}
%  \tableofcontents
%\end{frame}

\makeatletter
\newenvironment{btHighlight}[1][]
{\begingroup\tikzset{bt@Highlight@par/.style={#1}}\begin{lrbox}{\@tempboxa}}
{\end{lrbox}\bt@HL@box[bt@Highlight@par]{\@tempboxa}\endgroup}

\newcommand\btHL[1][]{%
  \begin{btHighlight}[#1]\bgroup\aftergroup\bt@HL@endenv%
}
\def\bt@HL@endenv{%
  \end{btHighlight}%
  \egroup
}
\newcommand{\bt@HL@box}[2][]{%
  \tikz[remember picture]{%
    \pgfpathrectangle{\pgfpoint{1pt}{0pt}}{\pgfpoint{\wd #2}{\ht #2}}%
    \pgfusepath{use as bounding box}%
    \node[anchor=base west,%
          outer sep=0pt,%
          inner xsep=1pt,%
          inner ysep=0pt,%
          rounded corners=2pt,%
          minimum height=\ht\strutbox+1pt,%
          #1]%
          {%
            \raisebox{1pt}{\strut}\strut\usebox{#2}%
          };%
  }%
}
\makeatother

\section{Introduction}

\begin{frame}[fragile]{Key messages}
  \begin{itemize}
  \item Precision of contracts can be tailored to project need
  \item LLRs can be represented in Ada package specifications
  \item Test and proof can be easily combined

  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Agenda}
  \begin{itemize}
     \item Technical planning (REVEAL, INFORMED, V-lifecylce)
     \item Verification spectrum (checks with traffic lights on left, code on right, demonstrate each level of verification with an error - start with full Ada)
     \item Example code: Presenter and audience counter (first is more precise)o
     \item ask audience to id faults? Give them a 10-second count=down timer.
  \end{itemize}
\end{frame}

\section{What?}

\begin{frame}[fragile]{Static Analysis Summary}

  \lstdefinestyle{magic}{
    basicstyle=\tiny\tt,
    keywordstyle=\color{AnColour02},
    moredelim=**[is][{\btHL[fill=AnSecondaryYellow!50,name=error]}]{`}{`},
  }

  \begin{columns}
    \begin{column}{2cm}
      \begin{tikzpicture}[x=1cm,y=1.2cm]
        \tikzstyle{legend}=[font=\scriptsize,text badly centered,text width=1.6cm]
        \tikzstyle{unused}=[fill=white]
        \tikzstyle{error}=[fill=AnSecondaryRed]
        \tikzstyle{ok}=[fill=AnSecondaryGreen]

        \foreach \y in {1, 2, 3, 4, 5, 6} {
          \draw[fill=AnGrey01] (0, \y) -- (2, \y) -- (2, \y + 1) -- (0, \y + 1) -- (0, \y);
          \draw[white,thick]   (0, \y) -- (2, \y) -- (2, \y + 1) -- (0, \y + 1) -- (0, \y);
        }

        \node[legend] at (0.8, 6.5) {In \spark\ subset};
        \node[legend] at (0.8, 5.5) {Globals satisfied};
        \node[legend] at (0.8, 4.5) {Variables initialised};
        \node[legend] at (0.8, 3.5) {No RT errors};
        \node[legend] at (0.8, 2.5) {Partially proven};
        \node[legend] at (0.8, 1.5) {Fully\\proven};

        \draw<-1>[unused] (1.7, 6.5) circle (0.1cm);
        \draw<2>[error]   (1.7, 6.5) circle (0.1cm);
        \draw<3->[ok]     (1.7, 6.5) circle (0.1cm);

        \draw<-1>[unused]  (1.7, 5.5) circle (0.1cm);
        \draw<2>[error]    (1.7, 5.5) circle (0.1cm);
        \draw<3->[ok]      (1.7, 5.5) circle (0.1cm);

        \draw<-1>[unused] (1.7, 4.5) circle (0.1cm);
        \draw<2>[error]   (1.7, 4.5) circle (0.1cm);
        \draw<3->[ok]     (1.7, 4.5) circle (0.1cm);

        \draw<-1>[unused] (1.7, 3.5) circle (0.1cm);
        \draw<2>[error]   (1.7, 3.5) circle (0.1cm);
        \draw<3->[error]     (1.7, 3.5) circle (0.1cm);

        \draw<-1>[unused] (1.7, 2.5) circle (0.1cm);
        \draw<2>[error]   (1.7, 2.5) circle (0.1cm);
        \draw<3->[error]     (1.7, 2.5) circle (0.1cm);

        \draw<-1>[unused] (1.7, 1.5) circle (0.1cm);
        \draw<2>[error]   (1.7, 1.5) circle (0.1cm);
        \draw<3->[error]     (1.7, 1.5) circle (0.1cm);
      \end{tikzpicture}
    \end{column}

    \begin{column}{9cm}
      %\hrule

      \begin{onlyenv}<1>
      \begin{pxcode}[language=SPARK,style=magic,gobble=8]
        package Conference_Attendance
        is
           Max_Attendance : constant := 1000;
           type Count_T is range 0 .. Max_Attendance;
           Audience_Count, Presenter_Count : Count_T := 0;
           Presenter_Set : Name_Sets.Set;

           procedure Inc_Audience (N : Integer)
           with Global => (In_Out => Audience_Count),
                Pre    => (N >= 0, Audience_Count + N <= Max_Attendance),
                Post   => (Audience_Count = Audience_Count + N);

           procedure Inc_Presenter(Name : String)
           with Global => (In_Out => Presenter_Count, Presenter_List),
                Pre    => (Presenter_Count < Max_Attendance);
                Post   => (Presenters_Set.Insert(Name) and 
                           Presenter_Count = Presenters_Set.Count);
           ...


        package body Conference_Attendance
        is
           procedure Inc_Audience (N : Integer)
           is
           begin
              Audience_Count := Audience_Count - N;
           end Inc_Audience;

           ...

      \end{pxcode}
      \end{onlyenv}

      \begin{onlyenv}<2>
      \begin{pxcode}[language=SPARK,style=magic,gobble=8]
        package Conference_Numbers
        is
           A_Count, P_Count : Integer := 0;

           procedure Inc_Audience (N : Integer)
           with Global => (`In_Out => A_Count`),
                Pre    => (N >= 0),
                Post   => (A_Count = A_Count + N);
        end Counters;

        package body Counters
        is
           procedure Inc_Audience (N : Integer)
           is
           begin
              A_Count := A_Count + N;
           end Inc_Audience;
        end Counters;
      \end{pxcode}
      \end{onlyenv}

      \begin{onlyenv}<3>
      \begin{pxcode}[language=SPARK,style=magic,gobble=8]
        package Conference_Attendance
        is
           Max_Attendance : constant := 1000;
           type Count_T is range 0 .. Max_Attendance;
           Audience_Count, Presenter_Count : Count_T := 0;
           Presenter_Set : Name_Sets.Set;

           procedure Inc_Audience (N : Integer)
           with Global => (In_Out => Audience_Count),
                Pre    => (N >= 0, Audience_Count + N <= Max_Attendance),
                Post   => (Audience_Count = Audience_Count + N);

           procedure Inc_Presenter(Name : String)
           with Global => (In_Out => Presenter_Count, Presenter_List),
                Pre    => (Presenter_Count < Max_Attendance);
                Post   => (Presenters_Set.Insert(Name) and 
                           Presenter_Count = Presenters_Set.Count);
           ...


        package body Conference_Attendance
        is
           procedure Inc_Audience (N : Integer)
           is
           begin
              Audience_Count := `Audience_Count - N`;
           end Inc_Audience;

           ...
      \end{pxcode}
      \end{onlyenv}

      %\hrule
    \end{column}
  \end{columns}

\end{frame}

\end{document}

