\documentclass{beamer}

\usepackage{amsthm}
\usepackage{xcolor}
\usepackage{eurosym}
\usepackage[utf8]{inputenc}
\usepackage{tikz}
\usetikzlibrary{arrows,positioning}
\usepackage{pgflibraryshapes} % for ellipse shape

%\usepackage{beamerthemesplit}

\usepackage[absolute,overlay]{textpos}
\TPGrid{15}{10}

\newcommand{\vs}{\vspace{0.5cm}}

\definecolor{mygreen}{rgb}{0,0.7,0}

\usepackage{listings}
\usepackage{color}
\lstset{
	language=Ada,
	keywordstyle=\bfseries\ttfamily\color[rgb]{0,0,1},
	identifierstyle=\ttfamily,
	commentstyle=\color[rgb]{0.133,0.545,0.133},
	stringstyle=\ttfamily\color[rgb]{0.627,0.126,0.941},
        morekeywords=[1]some,
	showstringspaces=false,
	basicstyle=\tiny,
	numberstyle=\tiny,
	numbers=left,
	stepnumber=1,
	numbersep=10pt,
	tabsize=2,
	breaklines=true,
	prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
	breakatwhitespace=false,
	aboveskip={1.5\baselineskip},
  columns=fixed,
  extendedchars=true,
% frame=single,
% backgroundcolor=\color{lbcolor},
}

% special frames used to put source-code listings
\newenvironment{specialframe}{%
  \begin{frame}[fragile,environment=specialframe]}{\end{frame}}

\setbeamertemplate{theorems}[numbered]
\newtheorem{exercise}{Exercise}

\newenvironment{answer}[1][Answer]{\begin{trivlist}
\item[\hskip \labelsep {\bfseries #1}]}{\end{trivlist}}

\xdefinecolor{adacoreblue}{rgb}{0,0.34,0.59}
\xdefinecolor{adacoregrey}{rgb}{0.53,0.68,0.84}

\AtBeginSection[]{\frame{\frametitle{Outline}
\tableofcontents[current]}}
\AtBeginSubsection[]{\frame{\frametitle{Outline}
\tableofcontents[currentsection,currentsubsection]}}

\setbeamertemplate{footline}[page number]
\setbeamercolor{frametitle}{bg=adacoreblue!40!adacoregrey, fg=white}
\setbeamercolor{section in toc}{fg=adacoreblue}
\setbeamercolor{block title}{bg=adacoregrey, fg=white}
\setbeamertemplate{navigation symbols}{}
\setbeamercovered{transparent}
\setbeamertemplate{footline}
{%
  \hfill \insertframenumber\ / \inserttotalframenumber%
}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Compilation Phases}

\begin{itemize}
\item lexing: \verb|Scn| (mostly need to modify \verb|snames.ads|)
\item parsing: \verb|Par| (no work needed except for error recovery)
  \begin{itemize}
  \item \verb|Par.Ch2| .. \verb|Par.Ch13| match RM chapters
  \item \verb|Par.Ch4| for attributes
  \item \verb|Par.Ch13| for aspects
  \item \verb|Par.Prag| for pragmas
  \end{itemize}
\item semantic analysis: \verb|Sem| (where most work is done)
  \begin{itemize}
  \item \verb|Sem_Ch2| .. \verb|Sem_Ch13| match RM chapters
  \item \verb|Sem_Prag| for pragmas/aspects
  \item \verb|Sem_Attr| for attributes
  \end{itemize}
\item expansion: \verb|Exp| (little work for SPARK 2014)
  \begin{itemize}
  \item \verb|Exp_Ch2| .. \verb|Exp_Ch13| match RM chapters
  \item \verb|Exp_Prag| for pragmas/aspects
  \item \verb|Exp_Attr| for attributes
  \end{itemize}
\end{itemize}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{\textit{Possibly} and \textbf{Certainly} Relevant RM Chapters}

\begin{enumerate}
\item General
\item Lexical Elements
\item Declarations and Types
\item \textbf{Names and Expressions}
\item \textbf{Statements}
\item \textbf{Subprograms}
\item \textbf{Packages}
\item \textit{Visibility Rules}
\item Tasks and Synchronisation
\item Program Structure and Compilation Issues
\item Exceptions
\item Generic Units
\item Representation Issues
\end{enumerate}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Exercises}

\begin{exercise}
  Which procedure which does the semantic analysis of expression functions?
\end{exercise}

\visible<2>{\begin{answer}
\texttt{Sem\_Ch6.Analyze\_Expression\_Function}
\end{answer}}

\begin{exercise}
  Which procedure does the semantic analysis of attribute \verb|'Old|?
\end{exercise}

\visible<2>{\begin{answer}
\texttt{Sem\_Attr.Analyze\_Attribute}
\end{answer}}

\begin{exercise}
  Which procedure does the expansion of attribute \verb|'Old|?
\end{exercise}

\visible<2>{\begin{answer}
\texttt{Exp\_Attr.Expand\_N\_Attribute\_Reference}
\end{answer}}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{GNAT Abstract Syntax Tree}

\begin{block}{internal nodes}
  \begin{itemize}
  \item \verb|Sinfo|, 226 values in kind \verb|Sinfo.Node_Kind|
  \item tree structure provided by syntactic fields
  \item function \verb|Parent| points to tree root
  \item additional semantic fields
  \item 5 general purpose fields for other nodes, list of nodes, names
    literals, universal integers, floats, character codes
  \end{itemize}
\end{block}

\begin{block}{entity nodes}
  \begin{itemize}
  \item \verb|Einfo|, 79 values in kind \verb|Einfo.Entity_Kind|
  \item for all identifiers
  \item 23 general purpose fields
  \item many boolean flags
  \end{itemize}
\end{block}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Internal AST Nodes}

how to describe a new node?
\begin{itemize}
\item GNAT Book (2.2.1 The Abstract Syntax Tree)
\item file \verb|sinfo.ads| (starts with 7500 lines of comments)
\end{itemize}

\vs

what to describe?
\begin{itemize}
\item source location (sloc) if any
\item syntactic fields and semantic fields
\item field default value if any
\end{itemize}

\vs

what else to know?
\begin{itemize}
\item same fields in 2 nodes use same general purpose field
\item constructors \verb|Make_<node>| auto-generated in \verb|Nmake|
\item files auto-generated by \verb|xsinfo|, \verb|xnmake| and \verb|xtreeprs|
\end{itemize}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Exercises}

\begin{exercise}
  What are the node kinds for a subprogram declaration and specification?
\end{exercise}

\visible<2>{\begin{answer}
\texttt{N\_Subprogram\_Declaration, N\_Procedure\_Specification} and \texttt{N\_Function\_Specification}
\end{answer}}

\begin{exercise}
  What is the entity kind \verb|E_Subprogram_Body| used for?
\end{exercise}

\visible<2>{\begin{answer}
when subprogram body is separate from declaration
\end{answer}}

\begin{exercise}
  Add a new expression node \verb|N_Unknown|. What to update?
\end{exercise}

\visible<2>{\begin{answer}
in \texttt{sinfo.ads}: comments, \texttt{Node\_Kind}, node class definitions,
\texttt{Is\_Syntatic\_Field}, plus case statements to complete in
\texttt{sem.adb}, \texttt{sprint.adb}, \texttt{exp\_util.adb},
\texttt{sem\_res.adb}
\end{answer}}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Error Detection}

see comments in \verb|errout.ads|

\vs

redundant errors are suppressed

\vs

22 special characters used to insert information in the error message (sloc,
name, etc.)

\vs

2 most useful error procedures:
\begin{lstlisting}[language=ada]
  procedure Error_Msg_N (Msg : String; N : Node_Or_Entity_Id);
   -- Output a message at the Sloc of the given node

  procedure Error_Msg_F (Msg : String; N : Node_Id);
   --  Similar to Error_Msg_N except that the message is placed on the first
   --  node of the construct N (First_Node (N)).
\end{lstlisting}
\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Alfa Mode}

mode for GNATprove:
\begin{itemize}
\item \verb|gnat| called in this mode to generate cross-refs
\item \verb|gnat2why| called in this mode
\end{itemize}

\vs

triggered by debug switch \verb|-gnatd.F|

\vs

other relevant debug switches (see \verb|debug.adb|):
\begin{itemize}
\item \verb|-gnatd.V| - extensions for S14 (\verb|'Loop_Entry|, etc.)
\item \verb|-gnatd.D| - strict Alfa mode (switch \verb|--pendantic|)
\item \verb|-gnatd.E| - force Alfa mode (GNATprove mode \verb|force|)
\item \verb|-gnatd.G| - precondition only mode (GNATprove mode \verb|check|)
\item \verb|-gnatd.H| - special mode for package \verb|Standard|
\item \verb|-gnatd.K| - Alfa detection mode (GNATprove mode \verb|detect|)
\end{itemize}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Alfa Mode in GNAT Frontend}

\verb|Opt.Alfa_Mode| set to True

\verb|Opt.Full_Expander_Active| returns False

\vs

47 uses of \verb|Alfa_Mode| in frontend

49 used of \verb|Full_Expander_Active| in frontend

\vs

regular scanning/parsing/semantic analysis
\verb|Exp_Alfa.Expand_Alfa| called for expansion

\vs

special expansion does little:
\begin{itemize}
\item identifiers: add suffix to homonyms
\item calls: introduce temporaries for IN OUT arguments
\item renamings: replace by object being renamed
\end{itemize}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Cross-Refs Generated in Alfa Mode }

ALI files store compiler-generated info on units (cross-refs)

general info on xrefs in \verb|lib-xref.ads|

info on special Alfa xrefs in \verb|alfa.ads|

\vs

regular xrefs not sufficient because:
\begin{itemize}
\item they do not identify subprogram scopes (for entities and refs)
\item they do not handle refs through pointers
\item they lack some refs (instances, renamings)
\end{itemize}

\vs

special xrefs based on regular ones:
\begin{itemize}
\item \verb|Lib.Xref.Generate_Definition| called on defs (as usual)
\item \verb|Lib.Xref.Generate_Reference| called on refs (as usual)
\item \verb|Generate_Dereference| called on dereference
\item references not ignored anymore (instances, renamings)
\item defs/refs include info on scope
\item \verb|Collect_Alfa| generates internal Alfa xrefs
\end{itemize}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{Adding A New Pragma}

parsing in \verb|par-prag.adb|: usually nothing to do

\vs

semantic analysis in \verb|sem-prag.adb|:
\begin{itemize}
\item add case in \verb|Analyze_Pragma|
\item initial comment gives the syntax in BNF
\item check cases in which pragma applies (Ada version? GNAT?)
\item check legality rules (parameters, placement)
\item if error, call \verb|Error_Pragma| that does not return
\end{itemize}

\vs

expansion in \verb|exp-prag.adb|:
\begin{itemize}
\item initial comment gives expanded pseudo-code
\item build nodes with \verb|Make_<node>|
\item create temporaries with \verb|Make_Temporary|
\item insert statements with \verb|Insert_Action|
\item rewrite node with \verb|Rewrite|
\item possibly reanalyze with \verb|Analyze|
\end{itemize}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{}

\end{specialframe}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{specialframe}
  \frametitle{}

\end{specialframe}


\end{document}
