This file contains a log of the steps in the evaluation of GNATprove
and SPARK 2014 on Tokeneer.

Notes
-----
16 Apr 2013
---
in trunk/tokeneer:

number of rlu files:
find tokeneer/ -name "*.rlu" | wc -l
32

number of user rules:
find tokeneer/ -name "*.rlu" | xargs grep "):" | wc -l
110

number of prv files:
find tokeneer/ -name "*.prv" | wc -l
11

number of prv discharged VCs:
find tokeneer/ -name "*.prv" | xargs cat | grep -e "^[1234567890]" | wc -l
24


Experiments
-----------


First attempt (automated translation):
---
- ran translator script on the <tis> directory. The following lines were
  commented out so as to prevent translation and retain the original annotations:
     # lines = Remove_Inherit          (lines) #Removes "--# inherit" annotations.
     # lines = Convert_Own             (lines) #Converts "--# own" annotations.
     # lines = Convert_Initializes     (lines) #Converts "--# initializes" annotations.
     # lines = Convert_Global          (lines) #Converts "--# global" annotations.
     # lines = Convert_Derives         (lines) #Converts "--# derives" annotations.
     # lines = Convert_Hide            (lines) #Converts "--# hide" annotations.

- Annotations that referenced proof functions were manually commented out of the code.
- "Loop_Invariant" pragmas that were not directly under their enclosing loop were
  manually commented out.
- All "Refined_Pre" and "Refined_Post" aspects were manually converted into
  their respective pragmas.
- A total of 3 hour of work to bring the Tokeneer code in a state that can go through
  GNATprove.


Second attempt (pick up Yannick's manual translation)
---
- Started from Yannick's manual translation. In this translation proof functions had been
  manually converted into actual functions.
- Replaced some "Assert" pragmas with "Assert_And_Cut" and "Loop_Invariant" pragmas
  according to the code.
- Ran GNATprove and redirected output to "redirected_gnatprove_output.1" using the following command:
    gnatprove -P test.gpr --mode=prove --report=all --timeout=5 > redirected_gnatprove_output.1

- Counted the number of total VCs by executing the following command:
    grep -e "proved" redirected_gnatprove_output.1 | wc -l
    288
- Counted the number of unproved VCs by executing:
    grep -e "not proved" redirected_gnatprove_output.1 | wc -l
    105

- Counted the number of total pre/post-condition VCs by executing:
    grep -e "condition proved" -e "condition not proved" redirected_gnatprove_output.1 | wc -l
    60
- Counted the number of unproved pre/post-condition VCs by executing:
    grep -e "condition not proved" redirected_gnatprove_output.1 | wc -l
    42

- Counted the number of total Assertion/Check VCs by executing:
    grep -e "assertion" -e "loop" redirected_gnatprove_output.1 | wc -l
    26
- Counter the number of unproved Assertion/Check VCs by executing:
    grep -e "assertion not proved" -e "loop .*not proved" redirected_gnatprove_output.1 | wc -l
    10

- Counted the number of total RTEF VC by executing:
    grep -e "range check" -e "overflow check" -e "division check" -e "index check" redirected_gnatprove_output.1 | wc -l
    202
- Counted the number of unproved RTEF VC by executing:
    grep -e "range check not proved" -e "overflow check not proved" -e "division check not proved" -e "index check not proved" redirected_gnatprove_output.1 | wc -l
    53

Proof statistics table:
====================    ======   ==========   =====
VCs associated with:    Proved   Not Proved   Total
====================    ======   ==========   =====
Pre/Post-conditions     18       42           60
Assertions/Checks       16       10           26
RTEF                    149      53           202
All types               183      105          288
====================    ======   ==========   =====

- The statistics about "In SPARK" and "NOT In SPARK " units are stored in "gnatprove.out.1".


Third attempt (try to prove auditlog.adb)
---
- Added specs to subroutines that had pre/post-conditions on the body without having any specs.

- Moved all types that lied on the body of auditlog to the spec. That was done in order to be able
  to add pre/post-conditions on the specs of subroutines that previously had their pre/post-conditions
  on the body (these pre/post-conditions referenced the carried-over types).

- Ran GNATprove on auditlog.adb and redirected output to "redirected_gnatprove_output.2" using the following command:
    gnatprove -P test.gpr --mode=prove --report=all --timeout=5 -u auditlog.adb > redirected_gnatprove_output.2

- Counted the number of total VCs by executing the following command:
    grep -e "proved" redirected_gnatprove_output.2 | wc -l
    92
- Counted the number of unproved VCs by executing:
    grep -e "not proved" redirected_gnatprove_output.2 | wc -l
    18

- Counted the number of total pre/post-condition VCs by executing:
    grep -e "condition proved" -e "condition not proved" redirected_gnatprove_output.2 | wc -l
    16
- Counted the number of unproved pre/post-condition VCs by executing:
    grep -e "condition not proved" redirected_gnatprove_output.2 | wc -l
    6

- Counted the number of total Assertion/Check VCs by executing:
    grep -e "assertion" -e "loop" redirected_gnatprove_output.2 | wc -l
    15
- Counter the number of unproved Assertion/Check VCs by executing:
    grep -e "assertion not proved" -e "loop .*not proved" redirected_gnatprove_output.2 | wc -l
    3

- Counted the number of total RTEF VC by executing:
    grep -e "range check" -e "overflow check" -e "division check" -e "index check" redirected_gnatprove_output.2 | wc -l
    61
- Counted the number of unproved RTEF VC by executing:
    grep -e "range check not proved" -e "overflow check not proved" -e "division check not proved" -e "index check not proved" redirected_gnatprove_output.2 | wc -l
    9

====================    ======   ==========   =====
VCs associated with:    Proved   Not Proved   Total
====================    ======   ==========   =====
Pre/Post-conditions     10       6            16
Assertions/Checks       12       3            15
RTEF                    52       9            61
All types               74       18           92
====================    ======   ==========   =====

- It is worth mentioning that all 9 not proved RTEF-related VCs were located on subroutines that had
  prv files associated with them, in the original Tokeneer example, in order to get fully proven.

- The statistics about "In SPARK" and "NOT In SPARK " units are stored in "gnatprove.out.2".

- The changes performed on auditlog.ads and auditlog.adb had the following effects on the general Tokeneer
  test case (in order to generate these outputs, commands similar to the previous ones were used
  [FILES: redirected_gnatprove_output_without_gnato.3, gnatprove.out.3.4]):
    ====================    ======   ==========   =====
    VCs associated with:    Proved   Not Proved   Total
    ====================    ======   ==========   =====
    Pre/Post-conditions     28       48           76
    Assertions/Checks       21       5            26
    RTEF                    177      51           228
    All types               226      104          330
    ====================    ======   ==========   =====

- Adding switch -gnato13 on the project file (test.gpr) had the following effects on the general Tokeneer
  test case (in order to generate these outputs, commands similar to the previous ones were used
  [FILES: redirected_gnatprove_output_with_gnato.4, gnatprove.out.3.4]):
    ====================    ======   ==========   =====
    VCs associated with:    Proved   Not Proved   Total
    ====================    ======   ==========   =====
    Pre/Post-conditions     28       48           76
    Assertions/Checks       21       5            26
    RTEF                    143      51           194
    All types               192      104          296
    ====================    ======   ==========   =====


Fourth attempt (strengthen the pre/post-conditions to prove RTEF)
---
- There were 9 RTEF VCs left unproven from the previous stage. All of them were related to
  SPARK 2005 proof annotations that after been converted to their SPARK 2014 equivalents,
  had run-time checks associated with them (which is not the case for SPARK 2005 annotations).

- All 9 unproven RTEF VCs could not prove that the result of "UsedLogFiles.Length - 1" does not underflow.
  Strengthening preconditions by adding "UsedLogFiles.Length >= 1 and then" resulted in all 9 VCs getting
  discharged. We did however get an increased number of unproven pre/post-condition VCs.
  [FILES: redirected_gnatprove_output.5, gnatprove.out.5]
====================    ======   ==========   =====
VCs associated with:    Proved   Not Proved   Total
====================    ======   ==========   =====
Pre/Post-conditions     8        8            16
Assertions/Checks       12       3            15
RTEF                    61       0            61
All types               81       11           92
====================    ======   ==========   =====


Fifth attempt (moved 2 more pre/post-conditions from the bodies to the specs)
---
- Moved 2 pre/post-conditions, that had been previously mistakenly omitted, from the bodies to the specs.

- Removed pre/post-condition pragmas from subroutine bodies to improve code readability. These pragmas are
  ignored by GNATprove anyway.
[FILES: redirected_gnatprove_output.6, gnatprove.out.6]
====================    ======   ==========   =====
VCs associated with:    Proved   Not Proved   Total
====================    ======   ==========   =====
Pre/Post-conditions     15       6            21
Assertions/Checks       12       3            15
RTEF                    67       0            67
All types               94       9            103
====================    ======   ==========   =====


Sixth attempt (converted tagged types into regular types)
---
- There was a single tagged record that was converted into a regular record.
  All extensions of the tagged record had to be converted into regular records
  and functions that returned the original record from the extended ones had to
  manually be written.

- Converting the tagged record into a regular record disabled the propagation of
  functions from the original package to the extending ones. Hence, all
  references to such implicitly defined functions had to be replaced with calls
  of the original functions.

- Ran GNATprove on the entire project.
[FILES: redirected_gnatprove_output.7, gnatprove.out.7]
====================    ======   ==========   =====
VCs associated with:    Proved   Not Proved   Total
====================    ======   ==========   =====
Pre/Post-conditions     39       106          145
Assertions/Checks       21       5            26
RTEF                    192      44           236
All types               252      155          407
====================    ======   ==========   =====


Seventh attempt (no "-gnato" vs "-gnato11" vs "-gnato13" for auditlog.adb)
---
- Proof statistics for auditlog.adb without flag "-gnato" set.
[FILES: redirected_gnatprove_output.8.a, gnatprove.out.8.a]
====================    ======   ==========   =====
VCs associated with:    Proved   Not Proved   Total
====================    ======   ==========   =====
Pre/Post-conditions     15       6            21
Assertions/Checks       12       3            15
RTEF                    67       0            67
All types               94       9            103
====================    ======   ==========   =====

- Proof statistics for auditlog.adb with flag "-gnato11" set.
[FILES: redirected_gnatprove_output.8.b, gnatprove.out.8.b]
====================    ======   ==========   =====
VCs associated with:    Proved   Not Proved   Total
====================    ======   ==========   =====
Pre/Post-conditions     15       6            21
Assertions/Checks       12       3            15
RTEF                    67       0            67
All types               94       9            103
====================    ======   ==========   =====

*Observation* : Since the results of the 2 previous analyses are identical,
we assume that the default mode (when "-gnato" is not present) is "-gnato11".

- Proof statistics for auditlog.adb with flag "-gnato13" set.
[FILES: redirected_gnatprove_output.8.c, gnatprove.out.8.c]
====================    ======   ==========   =====
VCs associated with:    Proved   Not Proved   Total
====================    ======   ==========   =====
Pre/Post-conditions     15       6            21
Assertions/Checks       12       3            15
RTEF                    29       0            29
All types               56       9            65
====================    ======   ==========   =====

*Observation* : 38 less run-time-related VCs were generated when "-gnato13" was
used. However, all 38 VCs were discharged when "-gnato11" was used.

*Observation* : 18 VCs were related to RTEF of proof constructs (assertions and
contracts [previously SPARK05 annotations]). The "-gnato13" flag was used when
these 18 VCs were counted. These VCs did not have equivalent ones in SPARK 2005
since proving RTEF is not necessary within annotations (first order logic).
