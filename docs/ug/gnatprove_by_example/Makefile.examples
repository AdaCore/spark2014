DUMMY:=$(shell mkdir -p flow prove)

.PHONY: codepeer flow prove results clean force

RESULTS=$(PWD)/results
ALL=$(wildcard examples/*.adb)
ALL_FLOW_MSG=$(patsubst examples/%.adb,$(RESULTS)/%.flow,$(ALL))
ALL_PROVE_MSG=$(patsubst examples/%.adb,$(RESULTS)/%.prove,$(ALL))

gnatprove: flow prove

flow:
	cp examples/intro.gpr flow
	-cd flow && gnatprove -k -q -P intro.gpr --report=all --warnings=on --mode=flow \
	  > flow.results

prove:
	cp examples/intro.gpr prove
	cd prove && gnatprove -q -P intro.gpr --report=all --warnings=on --mode=prove \
	  --timeout=5 > prove.results

results: $(ALL_FLOW_MSG) $(ALL_PROVE_MSG)

# The apparently useless use of 'cat' is meant to ignore a possible empty
# result of 'grep'. In that case, force generation of a non-empty output,
# to avoid errors when creating the pdf document.

$(RESULTS)/%.flow: force
	cd $(RESULTS) && grep -e '^$*.ad' ../flow/flow.results | cat > $@
	test -s $@ || echo "no output" > $@

$(RESULTS)/%.prove: force
	cd $(RESULTS) && grep -e '^$*.ad' ../prove/prove.results | cat > $@
	test -s $@ || echo "no output" > $@

clean:
	rm -rf flow prove
