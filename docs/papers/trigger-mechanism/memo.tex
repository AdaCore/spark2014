\documentclass[a4paper,10pt]{report}
\usepackage[utf8x]{inputenc}
\usepackage[english,francais]{babel}
\usepackage{mathpartir}
\usepackage{amssymb}
\usepackage{amsmath}
\setcounter{tocdepth}{3}
\usepackage{graphicx}
\usepackage{xspace}
\usepackage{fullpage}
\usepackage{xcolor}

\newcommand{\atoms}{\mathit{atoms}}
\newcommand{\terms}{\mathit{terms}}
\newcommand{\atom}{\mathit{atom}}
\newcommand{\gen}{\vdash}
\newcommand{\pos}{\vdash_\mathit{pos}}
\newcommand{\dett}{\vdash_\mathit{det}}
\newcommand{\ngen}{\nvdash}
\newcommand{\npos}{\nvdash_\mathit{pos}}
\newcommand{\ndett}{\nvdash_\mathit{det}}
\newcommand{\nnot}{\mathit{not}}
\newcommand{\F}{\mathit{form}}
\newcommand{\T}{\mathit{lab}}
\newcommand{\A}{\mathit{assume}}
\newcommand{\B}{\mathit{bcp}}


%opening
\title{A model of the trigger mechanism in SMT Solvers}
\author{Claire Dross}

\begin{document}

\maketitle
\tableofcontents

\chapter{A Propositional Model for the Trigger Mechanism}
\section{A Simplified Sat-Solver}
We introduce a labeled propositional logic. A formula in this logic is a classical propositional
formula over atoms and labeled formulas. A labeled formula is a couple $[a]F$ where $F$ is a
formula and $a$ a set of atoms. It means that the formula $F$ can only be used by the solver if
every atom in $a$ is the atom of an assumed literal. A labeled formula is a model of a universally
quantified formula protected by a trigger. For example, $[A]B\rightarrow C$ is a formula which states 
that if we have $B$ triggered by the set of atom $\{A\}$ then we have $C$. This could be a model of
the first order formula $(\forall x [A(x)]. B(x))\rightarrow C$.

As in a solver that uses the trigger mechanism, two different sets are maintained through a
proof of unsatisfiability of a bunched of formulas $R$ :
\begin{itemize}
 \item $G$, the set of assumed literals
 \item $K$, the set of assumed labeled formulas.
\end{itemize}
We do not assume that formulas in $R$ are in CNF, rather that they are in some sort of simple clausal
form over literals and labeled formulas. We introduce a function $\downarrow$ that puts formulas
into this clausal form. To handle $\neg[a]F$, we introduce a function named $\nnot$ which takes
a labeled formula $[a]F$ and returns a formula that should be such that, if $F'$ and $nF'$ are the 	propositional formulas obtained by erasing every label in $[a]F$ and $\nnot([a]F)$,
$\neg F'\Leftrightarrow nF'$. The choice we make for $\nnot$ will be explained in next section.

\subsection{The General Rule System}
The expression $K,\ G,\ R\gen\Box$ means that the set of formulas $R$ together with the two sets
of assumed literals and formulas $G$ and $K$ is unsatisfiable. We model the solver by the following
rules :

\begin{eqnarray*}
&
\inferrule [Base-R]{
\Box\in R
}{
K,\ G,\ R\gen\Box
}\qquad
\inferrule [Base-G]{
G\vDash \Box
}{
K,\ G,\ R\gen\Box
}\\
&
\inferrule [Instantiation]{
[a]F \in K  \\ a \subseteq \atoms(G) \\ K,\ G,\ R\cup\downarrow F\gen\Box
}{
K,\ G,\ R\gen\Box
}\\
&
\inferrule [Sat-Formula]{
K\cup\{[a]F\},\ G,\ R\gen\Box\\ K,\ G,\ R\cup\{C'\}\cup \downarrow\neg([a]F)\gen\Box
}{
K,\ G,\ R\cup\{[a]F\vee C'\}\gen\Box
}\\
&
\inferrule [Sat-Literal]{
K,\ G\cup\{L\},\ R\gen\Box\\ K,\ G\cup\{\overline{L}\},\ R\cup\{C'\}\gen\Box
}{
K,\ G,\ R\cup\{L\vee C'\}\gen\Box
}
\end{eqnarray*}
The rules {\sc Base-R} and {\sc Base-G} are introduce to keep the rules for the assumption of
literals and labeled formulas as simple as possible. The rule {\sc Base-R} states that if $R$
contains the empty clause $\Box$, $R$ is unsatisfiable with any set $K$ and $G$. The rule {\sc Base-G}
states that if the set of assumed ground literals is inconsistent, $K$, $G$, $R$ is unsatisfiable.
It could model the action of theories over ground terms. Here, since we do not consider theories,
$G\vDash \Box\Leftrightarrow\exists L\in G.\ \overline L\in G$.

The rule {\sc Instantiation} models the mechanism of instantiation using the atoms contained in
assumed literals (returned by $\atoms(G)$) to unlabel an assumed labeled formula of $K$.
To preserve the fact that $R$ only contains formulas in clausal form, we use $\downarrow$
to transform $F$.

The rules {\sc Sat-Formula} and {\sc Sat-Literal} model a really simple version of a SAT. It assume
any element of any clause of $R$. The constraint propagation is done a posteriori thanks to the rule
{\sc Base-G}.

\subsection{We consider \emph{fair} derivations}
Every branch of a fair derivation that do not lead to a proof of $K,\ G,\ R\gen\Box$ is such that :
\begin{itemize}
 \item every assumed labeled formula that can be instantiated and that is
not already known to be true is instantiated
 \item an element of each assumed clause that is not already known to be true is assumed.
\end{itemize}
By definition, a fair derivation can only loop or halt if it encounters a \emph{saturated} state.
We say that a the triplet $K$, $G$, $R$ is saturated if :
\begin{itemize}
 \item $G\nvDash\Box$\footnote{$\vDash$ represents the classical sat mechanism where labeled
formulas are handled as literals.}
 \item $K\cup G\vDash R$
 \item $\forall [a]F\in K.\ a\subseteq\atoms(G)\Rightarrow K\cup G\vDash\downarrow F$.
\end{itemize}
Conversely,
if there is a derivation from a set $R$ that reach a saturated state, it means that there
is a fair derivation which will not come up with a proof of $\varnothing,\ \varnothing,\ R\gen\Box$.

\noindent
An example of a fair derivation is given by the following algorithm :
\begin{itemize}
 \item Phase of saturation :
   \begin{itemize}
    \item for each $L\in G$, remove every occurrence of $\overline L$ from the clauses of $R$ and
every clause of $R$ containing $L$. This step results from the application of {\sc SAT-Literal}
followed by the application of {\sc Base-G} on one of the resulting branches.
    \item if $\Box\in R$, stop, there is a proof of $K,\ G,\ R\gen\Box$.
This step results from the application of {\sc Base-R}
    \item if $K\cup G\vDash R$, begin a phase of instantiation.
    \item take some $C$ in $R$ such that $K\cup G\nvDash C$ and some $D$ such that $C=D\vee C'$.
If $D$ is a literal, restart the algorithm on both $K$, $G\cup\{D\}$, $R\setminus\{C\}$ and
$K$, $G\cup\{\overline D\}$, $R\setminus\{C\}\cup\{C'\}$. This step results from the application
of {\sc SAT-Literal}. If $D$ is a labeled formula, restart the algorithm on both
$K\cup\{D\}$, $G$, $R\setminus\{C\}$ and
$K$, $G$, $R\setminus\{C\}\cup\{C'\}\cup\downarrow\neg D$. This step results from the application
of {\sc SAT-Formula}.
   \end{itemize}
 \item Phase of instantiation :
   \begin{itemize}
    \item if there are no labeled formula $[a]F\in K$ such that $a\in\atoms(G)$ and
$K\cup G\nvDash\downarrow F$, stop, the triplet $K$, $G$, $R$ is saturated.
    \item for all $[a]F\in K$ such that $a\in\atoms(G)$ and $K\cup G\nvDash\downarrow F$,
add $\downarrow F$ to $R$. This step results from the application of {\sc Instantiation}.
   \end{itemize}
\end{itemize}
The fact that this algorithm create fair derivations is straightforward.

\section{The Negation of Labeled Formulas}
To decide a value for $\nnot$, we encode the intuitive meaning of triggers thanks to new atoms
$pA$, one per atom $A$, that encode the presence of $A$ in the atoms of the set of assumed literals.
A labeled formula $[A_1,\ \dots,\ A_n]F$ should behave as $(pA_1\wedge\dots\wedge pA_n)\rightarrow F$.
As a consequence, we would like to choose $\nnot$ such that the intuitive meaning of
$\nnot([A_1,\ \dots,\ A_n]F)$ is $pA_1\wedge\dots\wedge pA_n\wedge\neg F$. To express that,
we introduce a new kind of labels, called positive and written $\langle a\rangle$ where $a$ is a set
of atoms (in opposition, $[a]$ is called a negative label). Assuming $\langle a\rangle F$
means adding $a$ to the set of encountered atoms and then assuming $F$. We then define $\nnot$ to be
$\nnot([a]F)=\langle a\rangle\neg F$ and $\nnot(\langle a\rangle F)=[a]\neg F$.
\subsection{The Rule System $\pos$}
Bellow are the new rules that model the solver. They maintain a set $M$ of atoms that were explicitly
added to the set of encountered atoms by the assumption of a positively labeled formula.
To denote either a positively or a negatively labeled formula, we write $a:F$.

\begin{eqnarray*}
&
\inferrule [Base-R]{
\Box\in R
}{
K,\ G,\ M,\ R\pos\Box
}\qquad
\inferrule [Base-G]{
G\vDash\Box
}{
K,\ G,\ M,\ R\pos\Box
}\\
&
\inferrule [Positive-Instantiation]{
\langle a\rangle F \in K \\ K,\ G,\ M\cup a,\ R\cup\downarrow F\pos\Box
}{
K,\ G,\ M,\ R\pos\Box
}\\
&
\inferrule [Negative-Instantiation]{
[a]F \in K  \\ a \subseteq \atoms(G)\cup M \\ K,\ G,\ M,\ R\cup\downarrow F\pos\Box
}{
K,\ G,\ M,\ R\pos\Box
}\\
&
\inferrule [Sat-Formula]{
K\cup\{a:F\},\ G,\ M,\ R\pos\Box\\ K\cup \downarrow\neg(a:F),\ G,\ M,\ R\cup\{C'\}\pos\Box
}{
K,\ G,\ R\cup\{a:F\vee C'\}\pos\Box
}\\
&
\inferrule [Sat-Literal]{
K,\ G\cup\{L\},\ M,\ R\pos\Box\\ K,\ G\cup\{\overline{L}\},\ M,\ R\cup\{C'\}\pos\Box
}{
K,\ G,\ M,\ R\cup\{L\vee C'\}\pos\Box
}
\end{eqnarray*}
The rule {\sc Positive-Instantiation} handles positively labeled formulas as explained above. It adds
the label to the set $M$ and then adds $F$ to the set of clauses $R$.
The rule {\sc Negative-Instantiation} has been modified to use the set $M$ of explicitly added
encountered atoms as well as $\atoms(G)$ to match negative labels.

The notion of saturation from $\gen$ extended to $\pos$ as :
\begin{itemize}
 \item $G\nvDash\Box$
 \item $K\cup G\vDash R$
 \item $\forall [a]F\in K.\ a\subseteq\atoms(G)\cup M\Rightarrow K\cup G\vDash\downarrow F$.
 \item $\forall\langle a\rangle F\in K.\ a\subseteq\atoms(G)\cup M\wedge K\cup G\vDash\downarrow F$.
\end{itemize}

\subsection{$\pos$ is not deterministic}
$\pos$ is not deterministic, which means that there is some set of formulas $R$ such that
there exist both a proof of $\varnothing,\ \varnothing,\ \varnothing,\ R\pos\Box$ and a derivation
by $\pos$ that reach a saturated state.
\subsubsection*{Counter-example}
Let's consider $R=\{A_1\vee A_2,\ [A_1]B_1,\ \neg B_1\}$.
{\small
\begin{eqnarray*}
\inferrule* [Right=Sat]{
  \inferrule* [Left=Inst]{
      \inferrule* {G\vDash\Box}
      {\dots,\ \{\neg B_1,\ A_1,\ B_1\},\ \varnothing\pos\Box}
  }
  {\{[A_1]B_1\},\ \{\neg B_1,\ A_1\},\ \varnothing\pos\Box} \\
  \inferrule* [Right=Inst]{
      \inferrule* {G\vDash\Box}
      {\dots,\ \{\neg B_1,\ \neg A_1,\ B_1\},\ \dots\pos\Box}
  }
  {\{[A_1]B_1\},\ \{\neg B_1,\ \neg A_1\},\ \dots\pos\Box}
}{
\{[A_1]B_1\},\ \{\neg B_1\},\ \{A_1\vee A_2\}\pos\Box
}
\end{eqnarray*}
}%
is a proof of $\varnothing,\ \varnothing,\ \varnothing,\ R\pos\Box$.\\
But if the solver assumes $A_2$ before $A_1$, it will never end up with a proof of
$\varnothing,\ \varnothing,\ \varnothing,\ R\pos\Box$ :
{\small
\begin{eqnarray*}
\inferrule* [Right=Sat]{
  \inferrule* {
  \textsc{Saturated}
  }{\{[A_1]B_1\},\ \{\neg B_1,\ A_2\},\ \varnothing\npos\Box} \\
  \inferrule* [Right=Inst]{
    \inferrule* {G\vDash\Box}
    {\dots,\ \{\neg B_1,\ \dots, \ B_1\},\ \varnothing\pos\Box}
  }
  {\{[A_1]B_1\},\ \{\neg B_1,\ \neg A_2,\ A_1\},\ \varnothing\pos\Box}
}{
\{[A_1]B_1\},\ \{\neg B_1\},\ \{A_1\vee A_2\}\npos\Box
}
\end{eqnarray*}
}

\section{A Deterministic Set of Rules}
Since positive labels make it possible to state explicitly what should be added to the set of
encountered atoms $M$, we would like to consider formulas where every atom that should be added
to $M$ is explicitly stated. For example, for a clause $A_1\vee\neg A_2$, we could write
$\langle A_1\rangle A_1\vee \langle A_2\rangle\neg A_2$, where the fact that the corresponding atom
should be added to $M$ when assuming a literal is stated explicitly.

\subsection{The Rule System $\dett$}
Since the set of encountered axioms is maintained explicitly, there is no need to keep literals
in a separate set anymore. They can be stored in $K$ with labeled formulas. Here is the new set
of rules :

\begin{eqnarray*}
&
\inferrule [Base-R]{
\Box\in R
}{
K,\ M,\ R\dett\Box
}\qquad
\inferrule [Base-K]{
\{L |L\in K\}\vDash\Box
}{
K,\ M,\ R\dett\Box
}\\
&
\inferrule [Positive-Instantiation]{
\langle a\rangle F \in K \\ K,\ M\cup a,\ R\cup\downarrow F\dett\Box
}{
K,\ M,\ R\dett\Box
}\\
&
\inferrule [Negative-Instantiation]{
[a]F \in K  \\ a \subseteq M \\ K,\ M,\ R\cup\downarrow F\dett\Box
}{
K,\ M,\ R\dett\Box
}\\
&
\inferrule [Sat]{
K\cup\{D\},\ M,\ R\dett\Box\\ K\cup\downarrow\neg D,\ M,\ R\cup\{D\}\dett\Box
}{
K,\ M,\ R\cup\{D\vee C\}\dett\Box
}
\end{eqnarray*}
The notion of saturation becomes :
\begin{itemize}
 \item $\{L |L\in K\}\nvDash\Box$
 \item $K\vDash R$
 \item $\forall [a]F\in K.\ a\subseteq M\Rightarrow K\vDash \downarrow F$.
 \item $\forall\langle a\rangle F\in K.\ a\subseteq M\wedge K\vDash\downarrow F$.
\end{itemize}
\subsection{$\dett$ is deterministic}
$\dett$ is deterministic and can be encoded as the validity of a propositional formula.
If $F$ is a formula, let's define its encoding $\F(F)$ as :
\begin{itemize}
 \item $\F(A)= A$,
 \item $\F([A_1,\ \dots,\ A_n]F)=pA_1\wedge\dots\wedge pA_n\rightarrow \F(F)$,
 \item $\F(\langle A_1,\ \dots,\ A_n\rangle F)= pA_1\wedge\dots\wedge pA_n\wedge \F(F)$,
 \item $\F(F_1\wedge F_2)= \F(F_1)\wedge \F(F_2)$,
 \item $\F(F_1\wedge F_2)= \F(F_1)\wedge \F(F_2)$,
 \item $\F(\neg F) = \neg \F(F)$.
\end{itemize}
$\F$ distribute over $\wedge$, $\vee$ and $\neg$ and $\neg\F([a]F)=\F(\langle a\rangle F)$.
As a consequence, for all formula $F$, we have that
$\F(\downarrow F)\Leftrightarrow\F(F)$.

\subsubsection*{Proof of $\varnothing,\ \varnothing,\ R\dett\Box\Rightarrow\F(R)\vDash\Box$}
We want to prove that, for all sets $K$, $M$ and $R$, $K,\ M,\ R\dett\Box\Rightarrow
\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$. We proceed by structural induction over the proof of
$K,\ M,\ R\dett\Box$.
\begin{itemize}
 \item The last rule of the proof is {\sc Base-R}. Since $\Box\in R$,
$\Box\in\F(R)$ and $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
 \item The last rule of the proof is {\sc Base-K}. Since $L\in K$ and $\overline L\in K$,
$L\in \F(K)$ and $\overline L\in\F(K)$. As a consequence, $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
 \item The last rule of the proof is {\sc Positive-Instantiation} with the labeled formula
$\langle A_1,\ \dots,\ A_n\rangle F$. By induction hypothesis,
$\F(R)\cup \F(\downarrow F)\cup \{pA|A\in M\}\cup\{pA_1,\ \dots,\ pA_n\}\cup \F(K)\vDash\Box$.
Since $\langle A_1,\ \dots,\ A_n\rangle F\in K$, $\F(\langle A_1,\ \dots,\ A_n\rangle F)=
pA_1\wedge\dots\wedge pA_n\wedge\F(F)\in \F(K)$. Since $\F(F)\Leftrightarrow\F(\downarrow F)$,
$\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
 \item The last rule of the proof is {\sc Negative-Instantiation} with the labeled formula
$[A_1,\ \dots,\ A_n]F$ such that $\{A_1,\ \dots,\ A_n\}\subseteq M$. By induction hypothesis,
$\F(R)\cup \F(\downarrow F)\cup \{pA|A\in M\}\cup \F(K)\vDash\Box$.
Since $[A_1,\ \dots,\ A_n]F\in K$,
$\F([A_1,\ \dots,\ A_n]F)=pA_1\wedge\dots\wedge pA_n\rightarrow \F(F)\in \F(K)$ and since
$\{A_1,\ \dots,\ A_n\}\subseteq M$, $\{pA_1,\ \dots,\ pA_n\}\subseteq\{pA|A\in M\}$.
As a consequence, since $\F(F)\Leftrightarrow\F(\downarrow F)$,
we have that $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
 \item The last rule of the proof is {\sc Sat} with a clause $D\vee C$.
By induction hypothesis,
$\F(R)\cup\{pA|A\in M\}\cup\F(K)\cup\F(D)\vDash\Box$ and
$\F(R)\cup\F(C)\cup\{pA|A\in M\}\cup\F(K)\cup\F(\neg D)\vDash\Box$. Since
$\F(\neg D)=\neg\F(D)$,  $\F(R\cup\F(C))\cup\{pA|A\in M\}\cup\F(K)\cup\neg\F(D)\vDash\Box$ and,
as a consequence, $\F(R)\cup(\F(D)\vee\F(C))\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
Since $\F(D\vee C)=\F(D)\vee\F(C)$, we have that
$\F(R)\cup\F(D\vee C)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
\end{itemize}

\subsubsection*{Proof of $\F(R)\vDash\Box\Rightarrow\varnothing,\ \varnothing,\ R\dett\Box$}
If $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$ we would like that any strategy for $\dett$
that halts when $K,\ M,\ R\dett\Box$ or when the triplet $K,\ M,\ R$ is saturated, returns
a proof of $K,\ M,\ R\dett\Box$.

It is enough to show that :
\begin{enumerate}
 \item If $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$, then for each triplet $K',\ M',\ R'$
that appears in a derivation of $K,\ M,\ R\dett\Box$, $\F(R')\cup\{pA|A\in M'\}\cup\F(K')\vDash\Box$.
 \item If $K,\ M,\ R$ is saturated, then $\F(R)\cup\{pA|A\in M\}\cup\F(K)\nvDash\Box$.
\end{enumerate}
\paragraph{1.} 
We will show that $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$ at each step of a proof of
$K,\ M,\ R\dett\Box$ by structural induction. For the two rules of instantiation, the set
$\F(R)\cup\{pA|A\in M\}\cup\F(K)$ is strictly bigger in the premise than in the conclusion.
For {\sc Sat}, by induction hypothesis we have that
$\F(R)\cup\F(D\vee C)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$. Since $\F(D\vee C)=\F(D)\vee\F(C)$,
$\F(R)\cup\{pA|A\in M\}\cup\F(K)\cup\F(D)\vDash\Box$ and
$\F(R)\cup\F(C)\cup\{pA|A\in M\}\cup\F(K)\cup\F(\neg D)\vDash
\F(R)\cup\F(C)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
\paragraph{2.}
Let $K,\ M,\ R$ be a saturated triplet. To show that $\F(R)\cup\{pA|A\in M\}\cup\F(K)\nvDash\Box$,
we consider a model $I$ that maps an atom $A$ to  the boolean $A\in\{A|A\in K\}\cup\{pA|A\in M\}$
and we show that $I\vDash\F(R)\cup\{pA|A\in M\}\cup\F(K)$. By definition of $I$,
$I\vDash\{pA|A\in M\}$. To show that, for all $D\in K$, $I\vDash\F(D)$, let's proceed by induction
over the size of the normal form\footnote{The size of the normal form of $D$ is recursively
defined. The size of the normal form of a literal is one and the size of a labeled formula
$a:F$ is defined as one plus the sum of the size of the normal forms of $D\in\downarrow F$}
of $D$.
\begin{itemize}
 \item By definition of $I$, for all $A\in K$, $I\vDash A$.
 \item $\neg A\in K$. Since $K,\ M,\ R$ is saturated, $A\notin K$.
  By definition of $I$, for all $A\notin K$, $I\nvDash A$. As a consequence,  $I\vDash\neg A$.
 \item $\langle A_1,\ \dots,\ A_n\rangle F\in K$. Since $K,\ M,\ R$ is saturated,
$K\vDash\downarrow F$. It means that, for all $C\in\downarrow F$, there is a $D\in C$ such that
$D\in K$. Since the size of $D$'s normal form is strictly less than the size of
$\langle A_1,\ \dots,\ A_n\rangle F$'s normal form and $D\in K$, we have, by induction hypothesis,
that $I\vDash\F(D)$. As a consequence, $I\vDash\F(\downarrow F)$.
Since $\F(\downarrow F)\Leftrightarrow\F(F)$ and $\{A_1,\ \dots,\ A_n\}\subseteq M$,
$I\vDash pA_1\wedge\dots\wedge pA_n\wedge\F(F)=\F(\langle A_1,\ \dots,\ A_n\rangle F)$.
 \item $[A_1,\ \dots,\ A_n]F\in K$ and $\{A_1,\ \dots,\ A_n\}\nsubseteq M$. By definition of $I$,
$I\nvDash pA_1\wedge\dots\wedge pA_n$. As a consequence,
$I\vDash(pA_1\wedge\dots\wedge pA_n)\rightarrow\F(F)=\F([A_1,\ \dots,\ A_n]F)$.
 \item $[A_1,\ \dots,\ A_n]F\in K$ and $\{A_1,\ \dots,\ A_n\}\subseteq M$.
Since $K,\ M,\ R$ is saturated, $K\vDash\downarrow F$.
It means that, for all $C\in\downarrow F$, there is a $D\in C$ such that $D\in K$.
Since the size of $D$'s normal form is strictly less than the size of $[A_1,\ \dots,\ A_n]F$'s
normal form and $D\in K$, we have, by induction hypothesis, that $I\vDash\F(D)$.
As a consequence, $I\vDash\F(\downarrow F)$. Since $\F(\downarrow F)\Leftrightarrow\F(F)$,
$I\vDash(pA_1\wedge\dots\wedge pA_n)\rightarrow\F(F)=\F([A_1,\ \dots,\ A_n]F)$.
\end{itemize}
Since $K,\ M,\ R$ is saturated, $K\vDash R$. As a consequence, for each clause $C\in R$,
there is a $D\in C$ such the $D\in K$. Since $I\vDash\F(K)$, we have that $I\vDash\F(R)$.

\section{The Explicit Positive Labelization}
We have a deterministic set of rules for explicitly labeled formulas. We would like to have a 
systematic way of adding labels to a set of formulas $R$ so that we have, for the resulting set of
explicitly labeled formulas $\T_\bullet(R)$, that
$\varnothing,\ \varnothing,\ \T_\bullet(R)\dett\Box$ if and only if
there is no derivation from $\varnothing,\ \varnothing,\ \varnothing,\ R$ through $\pos$ that reaches
a saturated state.

\subsection{The Labeling Mechanism $\T_\bullet$}
$\pos$ adds $\atom(L)$ to the set of encountered axioms whenever $L$ is assumed. We would like to
keep this semantics, which means that a clause $A_1\vee\neg A_2$ should be labeled as
$\langle A_1\rangle A_1\vee\langle A_2\rangle\neg A_2=\langle A_1\rangle A_1\vee\neg [A_2]A_2$.
We define an explicitly labeled formula $F'$ inductively over the form of $F$. This definition
depends on the polarity of $F$, so that a positive occurrence of atom $A$ is labeled by
$\langle A\rangle A$ and a negative occurrence of $A$ by $[A]A$. In the rules below,
$\T_\bullet(F)$ (resp. $\T_\circ(F)$) is the translation of a positive (resp.
negative) occurrence of $F$. What is stated for $\T$ is true for both $\T_\circ$ and $\T_\bullet$.
\begin{itemize}
 \item $\T_\bullet(A)=\langle A\rangle A$,
 \item $\T_\circ(A)=[A]A$,
 \item $\T([a]F)=[a]\T(F)$,
 \item $\T(\langle a\rangle F)=\langle a\rangle\T(F)$,
 \item $\T(F_1\wedge F_2)=\T(F_1)\wedge\T(F_2)$,
 \item $\T(F_1\vee F_2)=\T(F_1)\vee\T(F_2)$,
 \item $\T_\bullet(\neg F)= \neg\T_\circ(F)$,
 \item $\T_\circ(\neg F)= \neg\T_\bullet(F)$.
\end{itemize}
$\T$ replaces every atom $A$ by $\langle A\rangle A$ or $[A]A$ depending on its polarity. Since
the partial normalization $\downarrow$ do not change the polarity of atoms,
$\T(F)\Leftrightarrow\T(\downarrow F)$\footnote{$F_1\Leftrightarrow F_2$ can always be understood as
$F_1\vDash F_2$ and $F_2\vDash F_1$.}.

\subsection{$\varnothing,\ \varnothing,\ \T_\bullet(R)\dett\Box$ is the determinization of
$\varnothing,\ \varnothing,\ \varnothing,\ R\pos\Box$}
$\varnothing,\ \varnothing,\ \T_\bullet(R)\dett\Box$ if and only if
$\varnothing,\ \varnothing,\ \varnothing,\ R$ can not reach in a saturated state through $\pos$.

\subsubsection*{If $\varnothing,\ \varnothing,\ \T_\bullet(R)\dett\Box$ then
$\varnothing,\ \varnothing,\ \varnothing,\ R$ can not reach a saturated state through $\pos$}

Since $\varnothing,\ \varnothing,\ \T_\bullet(R)\dett\Box \Rightarrow\F(\T_\bullet(R))\vDash\Box$,
it is enough to show that :
\begin{enumerate}
 \item If $\F(\T_\bullet(R))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}
\cup\F(\T_\bullet(K))\vDash\Box$,
then for each triplet $K',\ G',\ M',\ R'$ that appears in a derivation of $K,\ G,\ M,\ R\pos\Box$,
$\F(\T_\bullet(R'))\cup\{pA|A\in M'\}\cup\{pA\wedge L|L\in G',\ A=\atom(L)\}
\cup\F(\T_\bullet(K'))\vDash\Box$.
 \item If $K,\ G,\ M,\ R$ is saturated, then
$\F(\T_\bullet(R))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}\cup
\F(\T_\bullet(K))\nvDash\Box$.
\end{enumerate}

\paragraph{1.}
We will show that $\F(\T_\bullet(R))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}
\cup\F(\T_\bullet(K))\vDash\Box$ at each step of a proof of
$K,\ G,\ M,\ R\pos\Box$ by structural induction. 
\begin{itemize}
 \item For the two rules of instantiation, the set
$\F(\T_\bullet(R))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}\cup\F(\T_\bullet(K))$
is strictly bigger in the premise than in the conclusion.
 \item For {\sc Sat-Literal}, by induction hypothesis we have that
$\F(\T_\bullet(R))\cup\F(\T_\bullet(L\vee C))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}
\cup\F(\T_\bullet(K))\vDash\Box$.
Since $\F(\T_\bullet(L\vee C))=\F(\langle A\rangle L)\vee\F(\T_\bullet(C))=
pA\wedge L\vee\F(\T_\bullet(C))$, we have that
$\F(\T_\bullet(R))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}
\cup\{pA\wedge L\}\cup\F(\T_\bullet(K))\vDash\Box$ and
$\F(\T_\bullet(R))\cup\F(\T_\bullet(C))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}
\cup\F(\T_\bullet(K))\cup\F(\T_\bullet(\overline L))\vDash\Box$.
 \item For {\sc Sat-Formula}, by induction hypothesis we have that
$\F(\T_\bullet(R))\cup\F(\T_\bullet(a:F\vee C))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}
\cup\F(\T_\bullet(K))\vDash\Box$.
Since $\F(\T_\bullet(a:F\vee C))=\F(\T_\bullet(a:F))\vee\F(\T_\bullet(C))$, we have that
$\F(\T_\bullet(R))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}
\cup\F(\T_\bullet(K))\cup\F(\T_\bullet(a:F))\vDash\Box$ and
$\F(\T_\bullet(R))\cup\F(\T_\bullet(C))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}
\cup\F(\T_\bullet(K))\cup\F(\T_\bullet(\downarrow\neg a:F))\vDash\Box$.
\end{itemize}

\paragraph{2.}
We will show that if $K,\ G,\ M,\ R$ is saturated for $\pos$, then
$\F(\T_\bullet(R))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}\cup
\F(\T_\bullet(K))\nvDash\Box$.
We consider a model $I$ that maps an atom $A$ to the boolean
$A\in\{A|A\in G\}\cup\{pA|A\in M\cup\atoms(G)\}$
and we show that $I\vDash\F(\T_\bullet(R))\cup\{pA|A\in M\}\cup\{pA\wedge L|L\in G,\ A=\atom(L)\}\cup
\F(\T_\bullet(K))$.
\begin{itemize}
 \item By definition of $I$, $I\vDash\{pA|A\in M\}$.
 \item $A\in G$. By definition of $I$, $I\vDash A$ and $I\vDash pA$. As a consequence, 
$I\vDash pA\wedge A$.
 \item $\neg A\in G$. Since $K,\ M,\ G,\ R$ is saturated, $A\notin G$. By definition of $I$,
$I\vDash pA$ and $I\vDash\neg A$. As a consequence, $I\vDash pA\wedge\neg A$.
 \item $F\subseteq K$. To show that $I\vDash\F(\T_\bullet(F))$, we proceed by induction on
the size of the normal form of $\T_\bullet(F)$.
\begin{itemize}
 \item $\langle A_1,\ \dots,\ A_n\rangle F\in K$. Since $K,\ M,\ G,\ R$ is saturated,
$\{A_1,\ \dots,\ A_n\}\subseteq M\cup\atoms(G)$ and, for each $C\in\downarrow F$, there is $D\in C$
such that $D\in K\cup G$. If $D\in G$, $I\vDash pA\wedge D=\F(\langle A\rangle D)=\F(\T_\bullet(D))$.
If $D\in G$, since the size of $D$'s normal form is strictly less than the size of
$\langle A_1,\ \dots,\ A_n\rangle F$'s normal form, we have, by induction hypothesis, 
$I\vDash\F(\T_\bullet(D))$. As a consequence, $I\vDash \F(\T_\bullet(\downarrow F))$.
Since $\F(\T_\bullet(\downarrow F))\Leftrightarrow\F(\T_\bullet(F))$ and 
$\{A_1,\ \dots,\ A_n\}\subseteq M$, $I\vDash pA_1\wedge\dots\wedge pA_n\wedge\F(\T_\bullet(F))=
\F(\T_\bullet(\langle A_1,\ \dots,\ A_n\rangle F))$.
 \item $[A_1,\ \dots,\ A_n]F\in K$ and $\{A_1,\ \dots,\ A_n\}\nsubseteq M\cup\atoms(G)$. 
By definition of $I$, $I\nvDash pA_1\wedge\dots\wedge pA_n$. As a consequence, $I\vDash(pA_1\wedge\dots\wedge pA_n)\rightarrow \F(\T_\bullet(F))=\F(\T_\bullet([A_1,\ \dots,\ A_n]F))$.
 \item $[A_1,\ \dots,\ A_n]F\in K$ and $\{A_1,\ \dots,\ A_n\}\subseteq M\cup\atoms(G)$.
Like for $\langle A_1,\ \dots,\ A_n\rangle F$, we can deduce that
$I\vDash\F(\T_\bullet(\downarrow F))$.
Since $\F(\T_\bullet(\downarrow F))\Leftrightarrow\F(\T_\bullet(F))$,
$I\vDash(pA_1\wedge\dots\wedge pA_n)\rightarrow \F(\T_\bullet(F))=\F(\T_\bullet([A_1,\ \dots,\ A_n]F))$.
\end{itemize}
\item Since $K,\ G,\ M,\ R$ is saturated, $K\cup G\vDash R$. As a consequence, for each clause $C\in R$,
there is a $D\in C$ such that $D\in K\cup G$. Since $I\vDash\F(\T_\bullet(K))\cup\F(\T_\bullet(G))$,
we have that $I\vDash\F(\T_\bullet(R))$.
\end{itemize}

\subsubsection*{If $\varnothing,\ \varnothing,\ \varnothing,\ R$ can not reach a 
saturated state through $\pos$, $\varnothing,\ \varnothing,\ \T_\bullet(R)\dett\Box$}
We say that $K_1$ is \emph{saturated in respect to} $K_2$, $G$, $M$ and $R$ if, for all
$a:F\in K_1$, $a\in M\cup\atoms(G)$ and $R\cup K_1\cup K_2\cup G\vDash\downarrow F$. Intuitively,
$K_1$ contains already instantiated labeled formulas.

\noindent
Let $K_1$, $K_2$, $G$, $M$ and $R$ be such that
\begin{itemize}
 \item $K_1$ is saturated in respect to $K_2$, $G$, $M$ and $R$,
 \item $K_1\cup K_2,\ G,\ M,\ R$ can not reach a saturated state through $\pos$.
\end{itemize}
To show that 
$\T_\bullet(K_1\cup K_2)\cup G,\ M\cup\atoms(G),\ \T_\bullet(R)\dett\Box$ we proceed by induction
on a lexicographic order composed of the sum of the sizes of $R$'s and $K_2$'s normal forms
and the size of the formal form of $R$.
\begin{itemize}
 \item $G\nvDash\Box$, $R=\varnothing$ and $K_2$ only contains negatively
labeled formulas $[a]F$ such that $a\notin M\cup \atoms(G)$. $K_1\cup K_2,\ G,\ M,\ R$ is saturated
which contradict the hypothesis.
 \item $G\vDash\Box$.
As a consequence, $\{L |L\in \T_\bullet(K_1\cup K_2)\cup G\}\vDash\Box$ and we get
$\T_\bullet(K_1\cup K_2)\cup G,\ M\cup\atoms(G),\ \T_\bullet(R)\dett\Box$ through the
{\sc Base-K} rule.
 \item There is $[a]F\in K_2$ such that $a\in M\cup \atoms(G)$.
The state $K_1\cup K_2,\ G,\ M,\ R\cup\downarrow F$ can not reach
a saturated state through $\pos$ since it can be reached from $K_1\cup K_2,\ G,\ M,\ R$ by
{\sc Negative-Instantiation}. What is more, the sum of the sizes of $R$'s and $K_2$'s normal forms
is strictly bigger than the sum of $R\cup\downarrow F$'s and $K_2\setminus\{[a]F\}$'s normal forms
and $K_1\cup\{[a]F\}$ is saturated in respect to $K_2\setminus\{[a]F\}$, $G$, $M$ and
$R\cup\downarrow F$. As a consequence,
by induction hypothesis, we have $\T_\bullet(K_1\cup K_2)\cup G,\ M\cup\atoms(G),\
\T_\bullet(R)\cup\downarrow \T_\bullet(F)\dett\Box$.
Since $[a]\T_\bullet(F)=\T_\bullet([a]F)\in \T_\bullet(K_2)$ and $a\in M\cup\atoms(G)$,
we have that $\T_\bullet(K_1\cup K_2)\cup G,\ M\cup\atoms(G),\ \T_\bullet(R)\dett\Box$
through {\sc Negative-Instantiation}.
 \item There is $\langle a\rangle F\in K_2$.
The state $K_1\cup K_2,\ G,\ M\cup a,\ R\cup\downarrow F$ can not
reach a saturated state through $\pos$ since it can be reached from $K_1\cup K_2,\ G,\ M,\ R$ by
{\sc Positive-Instantiation}. What is more, the sum of the sizes of $R$'s and $K_2$'s normal forms
is strictly bigger than the sum of $R\cup\downarrow F$'s and $K_2\setminus\{\langle a\rangle F\}$'s
normal forms and $K_1\cup\{\langle a\rangle F\}$ is saturated in respect to
$K_2\setminus\{\langle a\rangle F\}$, $G$, $M\cup a$ and $R\cup\downarrow F$. As a consequence,
by induction hypothesis, we have $\T_\bullet(K_1\cup K_2)\cup G,\ M\cup a\cup\atoms(G),\
\T_\bullet(R)\cup\downarrow \T_\bullet(F)\dett\Box$.
Since $\langle a\rangle \T_\bullet(F)=\T_\bullet(\langle a\rangle F)\in \T_\bullet(K_2)$,
we have that $\T_\bullet(K_1\cup K_2)\cup G,\ M\cup a\cup\atoms(G),\ \T_\bullet(R)\dett\Box$
through {\sc Positive-Instantiation}.
 \item There is a clause $C\in R$. We write $R'=R\setminus\{C\}$.
For all $L\in C$, the sate $K_1\cup K_2,\ G\cup\{L\},\ M,\ R'$ can not reach a saturated state through
$\pos$ since it can be reached from $K_1\cup K_2,\ G,\ M,\ R$ by {\sc Sat-Literal}.
What is more, the sum of the sizes of $R$'s and $K_2$'s normal forms
is strictly bigger than the sum of $R'$'s and $K_2$'s
normal forms and $K_1$ is saturated in respect to $K_2$, $G\cup\{L\}$, $M$ and $R'$. As a consequence,
by induction hypothesis, we have $\T_\bullet(K_1\cup K_2)\cup G\cup\{L\},\ M\cup\atoms(G\cup\{L\}),\
\T_\bullet(R')\dett\Box$. Using {\sc Positive-Instantiation}, we get that
$\T_\bullet(K_1\cup K_2\cup\{L\})\cup G,\ M\cup\atoms(G),\ \T_\bullet(R')\dett\Box$.
In the same way, for all $a:F\in C$, the sate $K_1\cup K_2\cup\{a:F\},\ G,\ M,\ R'$ can not reach a
saturated state through $\pos$ since it can be reached from $K_1\cup K_2,\ G,\ M,\ R$ by
{\sc Sat-Formula}. What is more, the sum of the sizes of $R$'s and $K_2$'s normal forms
is bigger or equal to the sum of $R'$'s and $K_2\cup\{a:F\}$'s
normal forms, the sizes of $R$'s normal form is strictly bigger than the sizes of $R'$'s normal form
and $K_1$ is saturated in respect to $K_2\cup\{a:F\}$, $G$, $M$ and $R'$. As a consequence,
by induction hypothesis, we have $\T_\bullet(K_1\cup K_2\cup\{a:F\})\cup G,\ M\cup\atoms(G),\
\T_\bullet(R')\dett\Box$.

We consequently have that, for all $D\in C$, $\T_\bullet(K_1\cup K_2\cup\{D\})\cup G,\ M\cup\atoms(G),\
\T_\bullet(R')\dett\Box$. To show that $\T_\bullet(K_1\cup K_2)\cup G,\ M\cup\atoms(G),\
\T_\bullet(R'\cup\{C\})\dett\Box$, we proceed by structural induction over $C$.
If $C=\Box$, $\Box\in \T_\bullet(R'\cup\{C\})$ and $\T_\bullet(K_1\cup K_2)\cup G,\ M\cup\atoms(G),\
\T_\bullet(R'\cup\{C\})\dett\Box$ through {\sc Base-R}. Otherwise, $C=D\vee E$,
By induction hypothesis, $\T_\bullet(K_1\cup K_2)\cup G,\ M\cup\atoms(G),\
\T_\bullet(R'\cup\{E\})\dett\Box$. With $\T_\bullet(K_1\cup K_2\cup\{D\})\cup G,\ M\cup\atoms(G),\
\T_\bullet(R')\dett\Box$, we can use the rule {\sc Sat} to get
$\T_\bullet(K_1\cup K_2)\cup G,\ M\cup\atoms(G),\ \T_\bullet(R'\cup\{C\})\dett\Box$.
\end{itemize} 

\chapter{A First-Order Model for the Trigger Mechanism}
\section{The ideal trigger mechanism}
\subsection{Formulas}
\noindent
A label $a$ is a set of terms. A formula can be either :
\begin{itemize}
 \item a literal : $L$,
 \item a unit : $F_1\wedge F_2$,
 \item a clause : $F_1\vee F_2$,
 \item a skolem : $\langle\overline x,a,\sigma\rangle F$,
 \item a lemma : $[\overline x,a,\sigma]F$.
\end{itemize}
In formulas, each literal $L$ that occurs positively is replaced by a skolem
$\langle\varnothing,\terms(L),\sigma_\varnothing\rangle L$ and each literal $L$ that occurs
negatively by a lemma $[\varnothing,\terms(L),\sigma_\varnothing]L$ where $\sigma_\varnothing$ is the
only mapping defined on $\varnothing$. This transformation from formulas to formulas is called
$\T$. It makes the mechanism that stores subterms of an assumed literals explicit. In the rest of
this chapter, we work on $\T(F)$.

\subsection{Functions}
\noindent
The function $\neg$ represents the negation over formulas. It is defined as :
\begin{itemize}
 \item $\neg L=\overline L$,
 \item $\neg(F_1\wedge F_2)=\neg F_1\vee\neg F_2$,
 \item $\neg(F_1\vee F_2)=\neg F_1\wedge\neg F_2$,
 \item $\neg(\langle\overline x,a,\sigma\rangle F)=[\overline x,a,\sigma]\neg F$,
 \item $\neg([\overline x,a,\sigma]F)=\langle\overline x,a,\sigma\rangle\neg F$.
\end{itemize}
An environment is a record $\{\Lambda,\Delta,T,M\}$ where $\Lambda$ is a set of lemmas,
$\Delta$ a set of pairs of formulas, $T$ a set of ground literals and
$M$ a set of ground terms. The function $\A$ modifies its environment by assuming a formula
$F$. It does the following :
\begin{itemize}
 \item $\A(\{\Lambda,\Delta,T,M\},L)=\{\Lambda,\Delta,T\cup L,M\}$,
 \item $\A(e,F_1\wedge F_2)=\A(\A(e,F_1),F_2)$,
 \item $\A(\{\Lambda,\Delta,T,M\},\langle\_,a,\sigma\rangle F)=
\A(\{\Lambda,\Delta,T,M\cup a\sigma\},F\sigma)$,
 \item $\A(\{\Lambda,\Delta,T,M\},[\overline x,a,\_]F)=\{\Lambda\cup([\overline x,a,\_]F),\Delta,T,M\}$,
 \item $\A(\{\Lambda,\Delta,T,M\},F_1\vee F_2)=\{\Lambda,\Delta\cup(F_1,F_2),T,M\}$.
\end{itemize}
The predicate $\vDash$ determine if a formula $F$ is implied by a set of lemmas $\Lambda$ and
a set of literals $T$. It is defined as :
\begin{itemize}
 \item $\Lambda,T,M\vDash L$ if and only if $L\in T$,
 \item $\Lambda,T,M\vDash F_1\wedge F_2$ if and only if $\Lambda,T,M\vDash F_1$
and $\Lambda,T,M\vDash F_2$,
 \item $\Lambda,T,M\vDash F_1\vee F_2$ if and only if $\Lambda,T,M\vDash F_1$ or
$\Lambda,T,M\vDash F_2$,
 \item $\Lambda,T,M\vDash\langle\_,a,\sigma\rangle F$ if and only if $\Lambda,T,M\vDash F\sigma$
and $a\sigma\subseteq M$,
 \item $\Lambda,T,M\vDash[\overline x,a,\sigma]F$ if and only if $[\overline x,a,\sigma]F\in\Lambda$.
\end{itemize}
The function $\B$ returns the set of candidates for a boolean constraint propagation.
It is defined as the smallest set such that:
\begin{itemize}
 \item if $\Lambda,T,M\vDash F_i$, $\{\Lambda,\Delta,T,M\}\in\B(\{\Lambda,\Delta\cup(F_1,F_2),T,M\})$,
 \item if $\Lambda,T,M\vDash\neg F_i$, $\A(\{\Lambda,\Delta,T,M\},F_i)\in
\B(\{\Lambda,\Delta\cup(F_1,F_2),T,M\})$.
\end{itemize}

\subsection{Rule system}
\noindent
Satisfiability of environments is handled by the following rules :
\begin{eqnarray*}
&
\inferrule [Base]{
T\vDash\Box
}{
\{\Lambda,\Delta,T,M\}\vdash\Box
}\qquad
\inferrule [Bcp]{
e'\vdash\Box\\ e'\in\B(e)
}{
e\vdash\Box
}\\
&
\inferrule [Instantiation]{
(\overline x,a,F)\in\Lambda\\ dom(\sigma)=\overline x\\ a\sigma\subseteq M\\
\A(\{\Lambda,\Delta,T,M\},F\sigma)\vdash\Box
}{
\{\Lambda,\Delta,T,M\}\vdash\Box
}\\
&
\inferrule [Sat]{
\A(\{\Lambda,\Delta,T,M\},F_i)\vdash\Box\\ \A(\A(\{\Lambda,\Delta,T,M\},F_j),\neg F_i)\vdash\Box
}{
\{\Lambda,\Delta\cup(F_1,F_2),T,M\}\vdash\Box
}
\end{eqnarray*}
The solver can return \emph{UNSAT} when a proof of $\{\Lambda,\Delta,T,M\}\vdash\Box$ has
been found.
\subsection{Saturation}
\noindent
We say that an environment $\{\Lambda,\Delta,T,M\}$ is saturated when :
\begin{itemize}
 \item $T\nvDash\Box$,
 \item for all $(F_1,F_2)\in\Delta$, exists $i\in[1..2]$ such that
$\Lambda,T,M\vDash F_i$,
 \item for all $(\overline x,a,F)\in\Lambda$ and all $\sigma$ such that
$dom(\sigma)=\overline x$ and $a\sigma\subseteq M$,
$\Lambda,T,M\vDash F\sigma$.
\end{itemize}
The solver can return \emph{SAT} whenever a saturated environment is encountered.

\section{The encoding}
\subsection{Definition}
\noindent
$\F$ is defined over formulas as :
\begin{itemize}
 \item $\F(L)=L$,
 \item $\F(F_1\wedge F_2)=\F(F_1)\wedge\F(F_2)$,
 \item $\F(F_1\vee F_2)=\F(F_1)\vee\F(F_2)$,
 \item $\F(\langle\overline x,a,\_\rangle F)=\exists\overline x.\bigwedge_{t\in a} p(t)\wedge\F(F)$,
 \item $\F([\overline x,a,\_]F)=\forall \overline x.\bigwedge_{t\in a} p(t)\rightarrow\F(F)$.
\end{itemize}
We can extend it to environments :\\
$\F(\{\Lambda,\Delta,T,M\})=\{\F(F)|F\in\Lambda\}
 \cup\{\F(F_1\vee F_2)|(F_1,F_2)\in\Delta\}\cup T\cup\{p(t)|t\in M\}$.
Notice that $\F(\neg F)=\neg\F(F)$.
\subsection{Properties}
\subsubsection*{$\F(\A(e,F))$ and $\F(e)\cup\F(F)$ are equisatisfiable.}
\noindent
We proceed by structural induction over $F$:
\begin{itemize}
 \item $\A(\{\Lambda,\Delta,T,M\},L)=\{\Lambda,\Delta,T\cup L,M\}$.
Since $\F(\{\Lambda,\Delta,T\cup L,M\})=\F(\{\Lambda,\Delta,T,M\})\cup L$,
$\F(\A(\{\Lambda,\Delta,T\cup L,M\}))=\F(\{\Lambda,\Delta,T,M\})\cup\F(L)$.
 \item $\A(e,F_1\wedge F_2)=\A(\A(e,F_1),F_2)$. Since $F_1$ and $F_2$ have a smaller size than
$F_1\wedge F_2$, we have, by induction hypothesis,
$\F(\A(\A(e,F_1),F_2))=\F(\A(e,F_1))\cup\F(F_2)$ and $\F(\A(e,F_1))=\F(e)\cup\F(F_1)$.
As a consequence, $\F(\A(e,F_1\wedge F_2))=\F(e)\cup\F(F_1)\cup\F(F_2)=\F(e)\cup\F(F_1\wedge F_2)$.
 \item $\A(\{\Lambda,\Delta,T,M\},F_1\vee F_2)=\{\Lambda,\Delta\cup(F_1,F_2),T,M\}$.
By construction of $\F$, we have that
$\F(\{\Lambda,\Delta\cup(F_1,F_2),T,M\})=\F(\{\Lambda,\Delta,T,M\})\cup\F(F_1\vee F_2)$.
As a consequence, we have $\F(\A(\{\Lambda,\Delta,T,M\},F_1\vee F_2))=
\F(\{\Lambda,\Delta,T,M\})\cup\F(F_1\vee F_2)$.
 \item $\A(\{\Lambda,\Delta,T,M\},\langle\_,a,\sigma\rangle F)=
\A(\{\Lambda,\Delta,T,M\cup a\sigma\},F\sigma)$. Since $F\sigma$ is strictly smaller than $F$,
we have, by induction hypothesis, $\F(\A(\{\Lambda,\Delta,T,M\cup a\sigma\},F\sigma))=
\F(\{\Lambda,\Delta,T,M\cup a\sigma\})\cup\F(F\sigma)$. Consequently,
$\F(\A(\{\Lambda,\Delta,T,M\},\langle\_,a,\sigma\rangle F))=
\F(\{\Lambda,\Delta,T,M\})\cup(\bigwedge_{t\in a} p(t)\wedge\F(F))\sigma$.
Since $\sigma$ maps $\overline x$ to Skolem functions,
$\F(\A(\{\Lambda,\Delta,T,M\},\langle\_,a,\sigma\rangle F))$ is indeed equisatisfiable with
$\F(\{\Lambda,\Delta,T,M\})\cup\exists\overline x.\bigwedge_{t\in a} p(t)\wedge\F(F)=
\F(\{\Lambda,\Delta,T,M\})\cup\F(\langle\overline x,a,\_\rangle F)$
 \item $\A(\{\Lambda,\Delta,T,M\},[\overline x,a,\_]F)=\{\Lambda\cup(\overline x,a,F),\Delta,T,M\}$.
By construction of $\F$, we have
$\F(\{\Lambda\cup(\overline x,a,F),\Delta,T,M\})=\F(\{\Lambda,\Delta,T,M\})\cup
\F([\overline x,a,\_]F)$. As a consequence, we have 
$\F(\A(\{\Lambda,\Delta,T,M\},[\overline x,a,\_]F))=
\F(\{\Lambda,\Delta,T,M\})\cup\F([\overline x,a,\_]F)$.
\end{itemize}

\subsubsection*{If $\Lambda, T,M\vDash F$ then $\{\F(F)|F\in\Lambda\}\cup T
\cup\{p(t)|t\in M\}\vDash\F(F)$.}
\noindent
We proceed by structural induction over $F$:
\begin{itemize}
 \item $\Lambda,T,M\vDash L$. By definition, $L\in T$ and $T\vDash L=\F(L)$.
 \item $\Lambda,T,M\vDash F_1\wedge F_2$. By definition, $\Lambda,T,M\vDash F_1$ and
$\Lambda,T,M\vDash F_2$. By induction hypothesis, $\{\F(F)|F\in\Lambda\}\cup T
\cup\{p(t)|t\in M\}\vDash\F(F_1)$
and $\{\F(F)|F\in\Lambda\}\cup T\cup\{p(t)|t\in M\}\vDash\F(F_2)$. As a consequence,
$\{\F(F)|F\in\Lambda\}\cup T\cup\{p(t)|t\in M\}\vDash\F(F_1)\wedge\F(F_2)=\F(F_1\wedge F_2)$.
 \item $\Lambda,T,M\vDash F_1\vee F_2$. By definition, $\Lambda\cup T\vDash F_1$ or
$\Lambda\cup T\vDash F_2$. By induction hypothesis, $\{\F(F)|F\in\Lambda\}\cup T
\cup\{p(t)|t\in M\}\vDash\F(F_1)$
or $\{\F(F)|F\in\Lambda\}\cup T\cup\{p(t)|t\in M\}\vDash\F(F_2)$. As a consequence,
$\{\F(F)|F\in\Lambda\}\cup T\cup\{p(t)|t\in M\}\vDash\F(F_1)\vee\F(F_2)=\F(F_1\vee F_2)$.
 \item $\Lambda,T,M\vDash[\overline x,a,\sigma]F$. By definition,
$[\overline x,a,\sigma]F\in\Lambda$ and
$\{\F(F)|F\in\Lambda\}\vDash\F([\overline x,a,\sigma]F)$.
 \item $\Lambda,T,M\vDash\langle\overline x,a,\sigma\rangle F$. By definition,
$\Lambda,T,M\vDash F\sigma$ and $a\sigma\subseteq M$. By induction hypothesis, we know that
$\{\F(F)|F\in\Lambda\}\cup T\cup\{p(t)|t\in M\}\vDash\F(F\sigma)$.
Since $\sigma$ maps $\overline x$ to Skolem functions,
$\{\F(F)|F\in\Lambda\}\cup T\vDash\exists\overline x.\bigwedge_{t\in a} p(t)\wedge\F(F)=
\F(\langle\overline x,a,\sigma\rangle F)$
\end{itemize}

\subsubsection*{If $e'\in\B(e)$ then $\F(e')$ and $\F(e)$ are equisatisfiable.}
\noindent
If $e'\in\B(e)$, then:
\begin{itemize}
 \item $e=\{\Lambda,\Delta\cup(F_1,F_2),T,M\}$, $e'=\{\Lambda,\Delta,T,M\}$ and
$\Lambda,T,M\vDash F_i$. Since $\F(e)=\F(e')\cup(\F(F_1)\vee\F(F_2))$,
$\F(e')\vDash\{\F(F)|F\in\Lambda\}\cup T\vDash\F(F)\cup\{p(t)|t\in M\}\vDash\F(F_i)$.
Consequently, $\F(e')\vDash\F(F_1)\vee\F(F_2)$ and $\F(e)\Leftrightarrow\F(e')$.
 \item $e=\{\Lambda,\Delta\cup(F_1,F_2),T,M\}$, $e'=\A(\{\Lambda,\Delta,T,M\},\F_i)$ and
$\Lambda,T,M\vDash\neg F_j$. Since $\F(e)=\F(\{\Lambda,\Delta,T,M\})\cup(\F(F_1)\vee\F(F_2))$
and $\F(\{\Lambda,\Delta,T,M\})\vDash\{\F(F)|F\in\Lambda\}\cup T\vDash\F(F)\cup
\{p(t)|t\in M\}\vDash\neg\F(F_j)$, $\F(e)\Leftrightarrow\F(\{\Lambda,\Delta,T,M\})\cup\F(F_i)$.
As a consequence, $\F(e)$ and $\F(e')$ are equisatisfiable.
\end{itemize}

\subsection{The ideal trigger mechanism is deterministic
 and the solver returns \emph{UNSAT} if and only if $\F(e)\vDash\Box$.}
\noindent
A rule system is said to be deterministic if a solver can not return both \emph{SAT} and
\emph{UNSAT} on any environment.
\subsubsection*{If there is a finite proof of $e\vdash\Box$, $\F(e)\vDash\Box$.}
We proceed by structural induction over the proof of $\{\Lambda,\Delta,T,M\}\vdash\Box$ :
\begin{itemize}
 \item The first applied rule is \textsc{Base}. As a consequence, $T\vDash\Box$. Since
$\F(\{\Lambda,\Delta,T,M\})\vDash T$, we have $\F(\{\Lambda,\Delta,T,M\})\vDash\Box$.
 \item The first applied rule is \textsc{Instantiation}. By induction hypothesis,
we have a substitution $\sigma$ such that $\F(\A(\{\Lambda,\Delta,T,M\},F\sigma))\vDash\Box$
and $a\sigma\subseteq M$. Since $(\overline x,a,F)\in\Lambda$,
$\F(\{\Lambda,\Delta,T,M\})\vDash\forall \overline x.\bigwedge_{t\in a} p(t)\rightarrow\F(F)$.
As a consequence, $\F(\{\Lambda,\Delta,T,M\})\vDash(\bigwedge_{t\in a} p(t)\rightarrow\F(F))\sigma$.
What is more, since $a\sigma\subseteq M$, $\F(\{\Lambda,\Delta,T,M\})\vDash\{p(t)|t\in a\sigma\}$.
Thus, $\F(\{\Lambda,\Delta,T,M\})\vDash\F(F)\sigma$ and
$\F(\{\Lambda,\Delta,T,M\})\vDash\F(\A(\{\Lambda,\Delta,T,M\},F\sigma))\vDash\Box$.
 \item The first applied rule is \textsc{Sat}. By induction hypothesis,
$\F(\A(\{\Lambda,\Delta,T,M\},F_i))\vDash\Box$ and
$\F(\A(\A(\{\Lambda,\Delta,T,M\},F_j),\neg F_i))\vDash\Box$.
Since, for all environment, $\F(\A(e,F))$ and $\F(e)\cup\F(F)$ are equisatisfiable
and $\F(\neg F)=\neg\F(F)$, $\F(\{\Lambda,\Delta,T,M\})\cup\F(F_i)\vDash\Box$ and
$\F(\{\Lambda,\Delta,T,M\})\cup\F(F_j)\cup\neg\F(F_i)\vDash\Box$. As a consequence,
we have indeed that $\F(\{\Lambda,\Delta,T,M\})\cup\F(F_1\vee F_2)\vDash\Box$.
 \item The first applied rule is \textsc{Bcp}. There is a $e'\in\B(e)$ such that
$e'\vdash\Box$. By induction hypothesis, $\F(e')\vDash\Box$. Since $\F(e)$ and $\F(e')$
are equisatisfiable, $\F(e)\vDash\Box$.
\end{itemize}

\subsubsection*{If $\F(e)\vDash\Box$, the solver can not reach a saturated state.}
The fact that if $\F(e)\vDash\Box$ in the conclusion of a rule, $\F(e)\vDash\Box$ in the premises
is obvious. As a consequence, we only need to show that if $e$ is saturated, there is a model $I$
for $\F(e)$. For a saturated environment $\{\Lambda,\Delta,T,M\}$, let's consider the model $I$
that associates true to elements of $\{A|A\in T\}\cup\{p(t)|t\in M\}$ and false to everything else.
\begin{itemize}
 \item By construction, $I\vDash\{p(t)|t\in M\}$ and $I\vDash T$.
 \item Let's show that, for all $[\overline x,a,\sigma]F\in\Lambda$, 
$I\vDash\F([\overline x,a,\sigma]F)$ by structural induction over $F$.
Since $\{\Lambda,\Delta,T,M\}$ is saturated, for all $\sigma$ such that
$dom(\sigma)=\overline x$ and $a\sigma\subseteq M$, $\Lambda,T,M\vDash F\sigma$.
By construction of $\vDash$, we also have $\Lambda|F\sigma,T,M\vDash F\sigma$ where
$\Lambda|F\sigma=\{F|F\in\Lambda,\ F\in F\sigma\}$.
As a consequence, $\{\F(F)|F\in\Lambda|F\sigma\}\cup T\cup\{p(t)|t\in M\}\vDash\F(F\sigma)$.
Since every element in $\Lambda|F\sigma$ is smaller than $[\overline x,a,\sigma]F$, 
we have, by induction hypothesis,
$I\vDash\{\F(F)|F\in\Lambda|F\sigma\}\cup T\cup\{p(t)|t\in M\}\vDash\F(F\sigma)$.
As a consequence, for all ground substitution $\sigma$ such that $dom(\sigma)=\overline x$,
either $a\sigma\subseteq M$ and $I\vDash\F(F\sigma)$ or $I\nvDash\{p(t)|t\in a\}$.
Thus, we always have $I\vDash(\bigwedge_{t\in a} p(t)\rightarrow\F(F))\sigma$ and
$I\vDash\forall \overline x.\bigwedge_{t\in a} p(t)\rightarrow\F(F)$.
 \item Let's show that for all $(F_1,F_2)\in\Delta$, $I\vDash\F(F_1\vee F_2)$. Since
$\{\Lambda,\Delta,T,M\}$ is saturated, exists $i\in[1..2]$ such that $\Lambda,T,M\vDash F_i$.
As a consequence, $I\vDash\{\F(F)|F\in\Lambda\}\cup T\cup\{p(t)|t\in M\}\vDash
\F(F_i)\vDash\F(F_1)\vee\F(F_2)=\F(F_1\vee F_2)$.
\end{itemize}

\chapter{Labeled Resolution}
\section{Presentation}
\subsection{Labeled Clauses}
We put our formulas in prenexe normal form, push negative labels externally (they are disjunctions) and
separate positive labels (they are cunjunctions). We consequently work on negatively labeled clauses 
containing positive labels and literals. For example, $(P(c)\wedge[x,P(x),d](P(x)\rightarrow Q(x))$
$[a]L_1\vee\langle b\rangle\vee L_3$ is one of
these clauses.
\subsection{Resolution Rules}
\begin{eqnarray*}
&
\inferrule [Labeled Resolution]{
[a]L\vee C\\ [a']L'\vee C'\\ \overline L\sigma=L'\sigma
}{
[a\sigma\cup a'\sigma](C\vee C')\sigma
}\\
&
\inferrule [Simple-Literal]{
[a]C\\ [a']L\vee C'\\ a\sigma\cap\terms(L)\sigma\neq\varnothing
}{
[(a\sigma\setminus\terms(L)\sigma)\cup a'\sigma](C \vee C')\sigma
}\\
&
\inferrule [Simple-Label]{
[a]C\\ [a']\langle b\rangle\vee C'\\ a\sigma\cap b\sigma\neq\varnothing
}{
[(a\sigma\setminus b\sigma)\cup a'\sigma](C \vee C')\sigma
}
\end{eqnarray*}
\paragraph{They are sound:}
\begin{itemize}
 \item \textsc{Labeled Resolution}:
 if we have both $(\bigvee_{t\in a}\neg p(t))\vee(\bigwedge_{t\in\terms(L)}p(t)\wedge L)\vee C$ and
$(\bigvee_{t\in a'}\neg p(t))\vee(\bigwedge_{t\in\terms(L')}p(t)\wedge L')\vee C'$ then
we have $(\bigvee_{t\in a\sigma\cup a'\sigma}\neg p(t))\vee(C\vee C')\sigma$.
 \item \textsc{Simple-Literal}:
 if we have both $(\bigvee_{t\in a}\neg p(t))\vee C$ and $(\bigvee_{t\in a'}\neg p(t))\vee
(\bigwedge_{t\in\terms(L)}p(t)\wedge L)\vee C'$ then
we have $(\bigvee_{t\in (a\sigma\setminus\terms(L)\sigma)\cup a'\sigma}\neg p(t))(C\vee C')\sigma$.
 \item \textsc{Simple-Label}:
 if we have both $(\bigvee_{t\in a}\neg p(t))\vee C$ and $(\bigvee_{t\in a'}\neg p(t))\vee
(\bigwedge_{t\in b}p(t))\vee C'$ then
we have $(\bigvee_{t\in (a\sigma\setminus b\sigma)\cup a'\sigma}\neg p(t))(C\vee C')\sigma$.
\end{itemize}
\paragraph{They are complete:}
Indeed, if we have a proof by resolution of $\Box$ over a set of standard clause derived from
a set of labeled clauses, then we can construct a derivation of $[\varnothing]\Box$ by the
three rules above. Indeed, each step that resolves over standard literals can be translated
as a step of \textsc{Labeled Resolution} over the labeled clauses from which the standard
clauses envolved were derived. In the same way, each step that resolves over a presence
predicate coming from a literal can be translated as a step of \textsc{Simple-Literal} and
each step that resolves over a presence predicate coming from a positive label can be
translated as a step of \textsc{Simple-Label}.

\end{document}
