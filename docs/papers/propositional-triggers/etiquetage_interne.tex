\documentclass[a4paper,11pt]{article}
\usepackage[utf8x]{inputenc}
\usepackage{mathpartir}
\usepackage{amssymb}
\usepackage{amsmath}
\setcounter{tocdepth}{3}
\usepackage{graphicx}
\usepackage{xspace}
\usepackage{xcolor}

\newcommand{\atoms}{\mathit{atoms}}
\newcommand{\atom}{\mathit{atom}}
\newcommand{\gen}{\vdash_\mathit{gen}}
\newcommand{\pos}{\vdash_\mathit{pos}}
\newcommand{\dett}{\vdash_\mathit{det}}
\newcommand{\ngen}{\nvdash_\mathit{gen}}
\newcommand{\npos}{\nvdash_\mathit{pos}}
\newcommand{\ndett}{\nvdash_\mathit{det}}
\newcommand{\nnot}{\mathit{not}}
\newcommand{\F}{\mathit{form}}
\newcommand{\T}{\mathit{lab}}


%opening
\title{A propositional model of the trigger mechanism in SMT Solvers}
\author{Claire Dross}

\begin{document}

\maketitle

\begin{abstract}

\end{abstract}

\section{A Propositional Model for the SAT Mechanism}
We introduce a labeled propositional logic. A formula in this logic is a classical propositional
formula over atoms and labeled formulas. A labeled formula is a couple $[a]F$ where $F$ is a
formula and $a$ a set of atoms. It means that the formula $F$ can only be used by the solver if
all atoms in $a$ have been encountered. A labeled formula is a model of a universally quantified
formula protected by a trigger. For example, $[A]B\rightarrow C$ is a formula which states that
if we have $B$ triggered by the set of atom $\{A\}$ then we have $C$. This could be a model of
the first order formula $(\forall x [A(x)]. B(x))\rightarrow C$.

As in a solver that uses the trigger mechanism, two different sets are maintained through a
proof of unsatisfiability of a bunched of formulas $R$ :
\begin{itemize}
 \item $G$, the set of assumed literals
 \item $K$, the set of assumed labeled formulas.
\end{itemize}
We do not assume that formulas in $R$ are in CNF, rather that they are in some sort of simple clausal
form over literals and labeled formulas. We introduce a function $\downarrow$ that puts formulas
into this clausal form. To handle $\neg[a]F$, we introduce a function named $\nnot$ which takes
a labeled formula $[a]F$ and returns a formula that should be such that, if $F'$ and $nF'$ are the 	propositional formulas obtained by erasing every label in $[a]F$ and $\nnot([a]F)$,
$\neg F'\Leftrightarrow nF'$. The choice we make for $\nnot$ will be explained in next section.

The expression $K,\ G,\ R\gen\Box$ means that the set of formulas $R$ together with the two sets
of assumed literals and formulas $G$ and $K$ is unsatisfiable. We model the solver by the following
rules :

\begin{eqnarray*}
&
\inferrule [Base-R]{
\Box\in R
}{
K,\ G,\ R\gen\Box
}\qquad
\inferrule [Base-G]{
G\vDash \Box
}{
K,\ G,\ R\gen\Box
}\\
&
\inferrule [Instantiation]{
[a]F \in K  \\ a \subseteq \atoms(G) \\ K,\ G,\ R\cup\downarrow F\gen\Box
}{
K,\ G,\ R\gen\Box
}\\
&
\inferrule [Sat-Formula]{
K\cup\{[a]F\},\ G,\ R\gen\Box\\ K,\ G,\ R\cup\{C'\}\cup \downarrow\neg([a]F)\gen\Box
}{
K,\ G,\ R\cup\{[a]F\vee C'\}\gen\Box
}\\
&
\inferrule [Sat-Literal]{
K,\ G\cup\{L\},\ R\gen\Box\\ K,\ G\cup\{\overline{L}\},\ R\cup\{C'\}\gen\Box
}{
K,\ G,\ R\cup\{L\vee C'\}\gen\Box
}
\end{eqnarray*}
The rules {\sc Base-R} and {\sc Base-G} are introduce to keep the rules for the assumption of
literals and labeled formulas as simple as possible. The rule {\sc Base-R} states that if $R$
contains the empty clause $\Box$, $R$ is unsatisfiable with any set $K$ and $G$. The rule {\sc Base-G}
states that if the set of assumed ground literals is inconsistent, $K$, $G$, $R$ is unsatisfiable.
It could model the action of theories over ground terms. Here, since we do not consider theories,
$G\vDash \Box\Leftrightarrow\exists L\in G.\ \overline L\in G$.

The rule {\sc Instantiation} models the mechanism of instantiation using the atoms contained in
assumed literals (returned by $\atoms(G)$) to unlabel an assumed labeled formula of $K$.
To preserve the fact that $R$ only contains formulas in clausal form, we use $\downarrow$
to transform $F$.

The rules {\sc Sat-Formula} and {\sc Sat-Literal} model a really simple version of a SAT. It assume
any element of any clause of $R$. The constraint propagation is done a posteriori thanks to the rule
{\sc Base-G}.

We are only interested in strategies that only halt in two states :
\begin{itemize}
 \item $K,\ G,\ R\gen\Box$
 \item the triplet $K$, $G$, $R$ is saturated :
\begin{itemize}
 \item $G\nvDash\Box$
 \item $K\cup G\vDash R$
 \item $\forall [a]F\in K.\ a\subseteq\atoms(G)\Rightarrow K\cup G\vDash F$.
\end{itemize}
\end{itemize}
Intuitively, if $K$, $G$, $R$ is saturated, then nothing more can be deduced through the application
of any rule and there can be no proof of $K,\ G,\ R\gen\Box$.

\section{The Negation of Labeled Formulas}
To decide a value for $\nnot$, we encode the intuitive meaning of triggers thanks to new atoms
$pA$, one per atom $A$, that encode the presence of $A$ in the atoms of the set of assumed literals.
A labeled formula $[A_1,\ \dots,\ A_n]F$ should behave as $(pA_1\wedge\dots\wedge pA_n)\rightarrow F$.
As a consequence, we would like to choose $\nnot$ such that the intuitive meaning of
$\nnot([A_1,\ \dots,\ A_n]F)$ is $pA_1\wedge\dots\wedge pA_n\wedge\neg F$. To express that,
we introduce a new kind of labels, called positive and written $\langle a\rangle$ where $a$ is a set
of atoms (in opposition, $[a]$ is called a negative label). Assuming $\langle a\rangle F$
means adding $a$ to the set of encountered atoms and then assuming $F$. We then define $\nnot$ to be
$\nnot([a]F)=\langle a\rangle\neg F$ and $\nnot(\langle a\rangle F)=[a]\neg F$.

Bellow are the new rules that model the solver. They maintain a set $M$ of atoms that were explicitly
added to the set of encountered atoms by the assumption of a positively labeled formula.
To denote either a positively or a negatively labeled formula, we write $a:F$.
\begin{eqnarray*}
&
\inferrule [Base-R]{
\Box\in R
}{
K,\ G,\ M,\ R\pos\Box
}\qquad
\inferrule [Base-G]{
G\vDash\Box
}{
K,\ G,\ M,\ R\pos\Box
}\\
&
\inferrule [Positive-Instantiation]{
\langle a\rangle F \in K \\ K,\ G,\ M\cup a,\ R\cup\downarrow F\pos\Box
}{
K,\ G,\ M,\ R\pos\Box
}\\
&
\inferrule [Negative-Instantiation]{
[a]F \in K  \\ a \subseteq \atoms(G)\cup M \\ K,\ G,\ M,\ R\cup\downarrow F\pos\Box
}{
K,\ G,\ M,\ R\pos\Box
}\\
&
\inferrule [Sat-Formula]{
K\cup\{a:F\},\ G,\ M,\ R\pos\Box\\ K\cup \downarrow\neg(a:F),\ G,\ M,\ R\cup\{C'\}\pos\Box
}{
K,\ G,\ R\cup\{a:F\vee C'\}\pos\Box
}\\
&
\inferrule [Sat-Literal]{
K,\ G\cup\{L\},\ M,\ R\pos\Box\\ K,\ G\cup\{\overline{L}\},\ M,\ R\cup\{C'\}\pos\Box
}{
K,\ G,\ M,\ R\cup\{L\vee C'\}\pos\Box
}
\end{eqnarray*}
The rule {\sc Positive-Instantiation} handles positively labeled formulas as explained above. It adds
the label to the set $M$ and then adds $F$ to the set of clauses $R$.
The rule {\sc Negative-Instantiation} has been modified to use the set $M$ of explicitly added
encountered atoms as well as $\atoms(G)$ to match negative labels.

The notion of saturation from $\gen$ extended to $\pos$ as :
\begin{itemize}
 \item $G\nvDash\Box$
 \item $K\cup G\vDash R$
 \item $\forall [a]F\in K.\ a\subseteq\atoms(G)\cup M\Rightarrow K\cup G\vDash F$.
 \item $\forall\langle a\rangle F\in K.\ a\subseteq M\wedge K\cup G\vDash F$.
\end{itemize}

\paragraph{Property :}
$\pos$ is not deterministic, which means that there are some sets of formulas $R$ such that
there exist both a proof of $\varnothing,\ \varnothing,\ \varnothing,\ R\pos\Box$ and a derivation
stuck in a saturated state. For example, let's consider
$R=\{A_1\vee A_2,\ [A_1]B_1,\ \neg B_1\}$.
{\small
\begin{eqnarray*}
\inferrule* [Right=Sat]{
  \inferrule* [Left=Inst]{
      \inferrule* {G\vDash\Box}
      {\dots,\ \{\neg B_1,\ A_1,\ B_1\},\ \varnothing\pos\Box}
  }
  {\{[A_1]B_1\},\ \{\neg B_1,\ A_1\},\ \varnothing\pos\Box} \\
  \inferrule* [Right=Inst]{
      \inferrule* {G\vDash\Box}
      {\dots,\ \{\neg B_1,\ \neg A_1,\ B_1\},\ \dots\pos\Box}
  }
  {\{[A_1]B_1\},\ \{\neg B_1,\ \neg A_1\},\ \dots\pos\Box}
}{
\{[A_1]B_1\},\ \{\neg B_1\},\ \{A_1\vee A_2\}\pos\Box
}
\end{eqnarray*}
}%
is a proof of $\varnothing,\ \varnothing,\ \varnothing,\ R\pos\Box$.

But if the solver assumes $A_2$ before $A_1$, it will never end up with a proof of
$\varnothing,\ \varnothing,\ \varnothing,\ R\pos\Box$ :
{\small
\begin{eqnarray*}
\inferrule* [Right=Sat]{
  \inferrule* {
  \textsc{Saturated}
  }{\{[A_1]B_1\},\ \{\neg B_1,\ A_2\},\ \varnothing\npos\Box} \\
  \inferrule* [Right=Inst]{
    \inferrule* {G\vDash\Box}
    {\dots,\ \{\neg B_1,\ \dots, \ B_1\},\ \varnothing\pos\Box}
  }
  {\{[A_1]B_1\},\ \{\neg B_1,\ \neg A_2,\ A_1\},\ \varnothing\pos\Box}
}{
\{[A_1]B_1\},\ \{\neg B_1\},\ \{A_1\vee A_2\}\npos\Box
}
\end{eqnarray*}
}

\section{A Deterministic Set of Rules}
Since positive labels make it possible to state explicitly what should be added to the set of
encountered atoms $M$, we would like to consider formulas where every atom that should be added
to $M$ is explicitly stated. For example, for a clause $A_1\vee\neg A_2$, we could write
$\langle A_1\rangle A_1\vee \langle A_2\rangle\neg A_2$, where the fact that the corresponding atom
should be added to $M$ when assuming a literal is stated explicitly.

Since the set of encountered axioms is maintained explicitly, there is no need to keep literals
in a separate set anymore. They can be stored in $K$ with labeled formulas. Here is the new set
of rules :
\begin{eqnarray*}
&
\inferrule [Base-R]{
\Box\in R
}{
K,\ M,\ R\dett\Box
}\qquad
\inferrule [Base-K]{
K\vDash\Box
}{
K,\ M,\ R\dett\Box
}\\
&
\inferrule [Positive-Instantiation]{
\langle a\rangle F \in K \\ K,\ M\cup a,\ R\cup\downarrow F\dett\Box
}{
K,\ M,\ R\dett\Box
}\\
&
\inferrule [Negative-Instantiation]{
[a]F \in K  \\ a \subseteq M \\ K,\ M,\ R\cup\downarrow F\dett\Box
}{
K,\ M,\ R\dett\Box
}\\
&
\inferrule [Sat]{
K\cup\{D\},\ M,\ R\dett\Box\\ K\cup\downarrow\neg D,\ M,\ R\cup\{D\}\dett\Box
}{
K,\ M,\ R\cup\{D\vee C\}\dett\Box
}
\end{eqnarray*}
The notion of saturation becomes :
\begin{itemize}
 \item $K\nvDash\Box$
 \item $K\vDash R$
 \item $\forall [a]F\in K.\ a\subseteq M\Rightarrow K\vDash F$.
 \item $\forall\langle a\rangle F\in K.\ a\subseteq M\wedge K\vDash F$.
\end{itemize}
\subsection{Property :}
$\dett$ is deterministic and can be encoded as the validity of a propositional formula.
If $F$ is a formula, let's define its encoding $\F(F)$ as :
\begin{itemize}
 \item $\F(A)= A$,
 \item $\F([A_1,\ \dots,\ A_n]F)=pA_1\wedge\dots\wedge pA_n\rightarrow \F(F)$,
 \item $\F(\langle A_1,\ \dots,\ A_n\rangle F)= pA_1\wedge\dots\wedge pA_n\wedge \F(F)$,
 \item $\F(F_1\wedge F_2)= \F(F_1)\wedge \F(F_2)$,
 \item $\F(F_1\wedge F_2)= \F(F_1)\wedge \F(F_2)$,
 \item $\F(\neg F) = \neg \F(F)$.
\end{itemize}
Since $\F$ distribute over $\wedge$, $\vee$ and $\neg$, for all formula $F$, we have that
$\F(\downarrow F)\Leftrightarrow\F(F)$.
\subsubsection*{Proof of $\varnothing,\ \varnothing,\ R\dett\Box\Rightarrow\F(R)\vDash\Box$}
We want to prove that, for all sets $K$, $M$ and $R$, $K,\ M,\ R\dett\Box\Rightarrow
\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$. We proceed by structural induction over the proof of
$K,\ M,\ R\dett\Box$.
\begin{itemize}
 \item The last rule of the proof is {\sc Base-R}. Since $\Box\in R$,
$\Box\in\F(R)$ and $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
 \item The last rule of the proof is {\sc Base-K}. Since $L\in K$ and $\overline L\in K$,
$L\in \F(K)$ and $\overline L\in\F(K)$. As a consequence, $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
 \item The last rule of the proof is {\sc Instanciation-Positive} with the labeled formula
$\langle A_1,\ \dots,\ A_n\rangle F$. By induction hypothesis,
$\F(R)\cup \F(\downarrow F)\cup \{pA|A\in M\}\cup\{pA_1,\ \dots,\ pA_n\}\cup \F(K)\vDash\Box$.
Since $\langle A_1,\ \dots,\ A_n\rangle F\in K$, $\F(\langle A_1,\ \dots,\ A_n\rangle F)=
pA_1\wedge\dots\wedge pA_n\wedge\F(F)\in \F(K)$. Since $\F(F)\Leftrightarrow\F(\downarrow F)$,
$\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
 \item The last rule of the proof is {\sc Instanciation-Negative} with the labeled formula
$[A_1,\ \dots,\ A_n]F$ such that $\{A_1,\ \dots,\ A_n\}\subseteq M$. By induction hypothesis,
$\F(R)\cup \F(\downarrow F)\cup \{pA|A\in M\}\cup \F(K)\vDash\Box$.
Since $[A_1,\ \dots,\ A_n]F\in K$,
$\F([A_1,\ \dots,\ A_n]F)=pA_1\wedge\dots\wedge pA_n\rightarrow \F(F)\in \F(K)$ and since
$\{A_1,\ \dots,\ A_n\}\subseteq M$, $\{pA_1,\ \dots,\ pA_n\}\subseteq\{pA|A\in M\}$.
As a consequence, since $\F(F)\Leftrightarrow\F(\downarrow F)$,
we have that $\F(R)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
 \item The last rule of the proof is {\sc Sat} with a clause $D\vee C$.
By induction hypothesis,
$\F(R)\cup\{pA|A\in M\}\cup\F(K)\cup\F(D)\vDash\Box$ and
$\F(R)\cup\F(C)\cup\{pA|A\in M\}\cup\F(K)\cup\F(\neg D)\vDash\Box$. Since
$\F(\neg D)=\neg\F(D)$,  $\F(R\cup\F(C))\cup\{pA|A\in M\}\cup\F(K)\cup\neg\F(D)\vDash\Box$ and,
as a consequence, $\F(R)\cup(\F(D)\vee\F(C))\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
Since $\F(D\vee C)=\F(D)\vee\F(C)$, we have that
$\F(R)\cup\F(D\vee C)\cup\{pA|A\in M\}\cup\F(K)\vDash\Box$.
\end{itemize}

\subsubsection*{Proof of $\F(R)\vDash\Box\Rightarrow\varnothing,\ \varnothing,\ R\dett\Box$}
Inversement, supposons que $F_M\cup F_R\cup F_K\vDash\Box$. Montrons que l'algorithme
fournit toujours une preuve de $K,\ M,\ R\dett\Box$, quelque soit la stratégie du SAT-Solver.

Pour cela, montrons que tout au long de l'algorithme on a $F_M\cup F_K\vDash\Box$ et qu'il n'existe pas de couple $K,\ M$ saturé tel que $F_M\cup F_K\vDash\Box$.\\
Il n'existe pas de couple $K,\ M$ saturé tel que $F_M\cup F_K\vDash\Box$. En effet, considérons
$I$ associant les élément de $\{A|A\in K\}\cup\{pA|A\in M\}$ à vrai et les autres à faux
et montrons que $I\vDash F_M\cup F_K$. Par définition de $F_M$, $I\vDash F_M$.
Montrons par induction sur la taille de la forme normale\footnote{La taille de la forme normale de $F$ est
définie récursivement. La taille de $L$ est 1 et celle de $a:F$ 1 plus la somme des tailles des formes normales de
tous les éléments de $\downarrow F$.} de $F\in K$ que $I\vDash F_F$.
\begin{itemize}
 \item Par construction de $I$, si $A\in K$ alors $I\vDash A$ et si $\neg A\in K$,
$A\notin K$ et $I\vDash \neg A$.
 \item Si $\langle a\rangle F\in K$ et $\langle a\rangle F\rightsquigarrow F_F$,
pour tout $E\in\downarrow F$,
il existe $D$ tel que $E=D\vee C,\ D\in K$ par définition de la saturation.
Soient $F_D$ et $F_C$ tels que $D\rightsquigarrow F_D$ et $C\rightsquigarrow F_C$.
Comme $D\in K$ a une forme normale de taille strictement inférieure à celle de $\langle a\rangle F$,
on a, par hypothèse de récurrence, que $I\vDash F_D$. Comme $E\rightsquigarrow F_D\vee F_C$,
$F_F\Leftrightarrow \{pA|A\in a\}\cup\{F_D\vee F_C| E=D\vee C\in\downarrow F\}$.
Comme $K,\ M$ est saturé, $a\subseteq M$ et $I\vDash F_F$. 
 \item Si $[A_1,\ \dots,\ A_n]F\in K$, $F\rightsquigarrow F_F$ et $\{A_1,\ \dots,\ A_n\}\nsubseteq M$, alors
$[A_1,\ \dots,\ A_n]F\rightsquigarrow (pA_1\wedge\dots\wedge pA_n)\rightarrow F_F$.
Comme $I\nvDash pA_1\wedge\dots\wedge pA_n$, $I\vDash(pA_1\wedge\dots\wedge pA_n)\rightarrow F_F$.
 \item Si $[A_1,\ \dots,\ A_n]F\in K$, $F\rightsquigarrow F_F$ et $\{A_1,\ \dots,\ A_n\}\subseteq M$, alors
$[A_1,\ \dots,\ A_n]F\rightsquigarrow (pA_1\wedge\dots\wedge pA_n)\rightarrow F_F$. 
Comme $K,\ M$ est saturé, pour tout $E\in\downarrow F$, il existe $D$ tel que $E=D\vee C,\ D\in K$.
Soient $F_D$ et $F_C$ tels que $D\rightsquigarrow F_D$ et $C\rightsquigarrow F_C$.
Comme $D\in K$ a une forme normale de taille strictement inférieure à celle de $[A_1,\ \dots,\ A_n]F$,
on a, par hypothèse de récurrence, que $I\vDash F_D$. Comme $E\rightsquigarrow F_D\vee F_C$,
$F_F\Leftrightarrow \{F_D\vee F_C|E=D\vee C\in\downarrow F\}$ et on a donc 
bien $I\vDash F_F\vDash \{(pA_1\wedge\dots\wedge pA_n)\rightarrow F_F\}$.
\end{itemize}
Montrons que $F_M\cup F_K\cup F_R\vDash\Box$ par induction sur la dérivation de preuve.
La seule règle non triviale est {\sc Sat}, en effet, les deux règles d'instanciation font croitre
l'ensemble $F_M\cup F_K\cup F_R$. Pour la règle {\sc Sat}, on sait que
$F_M\cup F_K\cup F_R\cup\{F_D\vee F_C\}\vDash\Box$. On a alors que
$F_M\cup F_K\cup\{F_D\}\cup F_R\vDash\Box$ et $F_M\cup F_K\cup\{\neg F_D\}\cup F_R\cup\{F_C\}\vDash\Box$.

\section{The Explicit Positive Labelization}
We have a deterministic set of rules for explicitly labeled formulas. We would like to have a 
systematic way of adding labels to a set of formulas $R$ so that we have, for the resulting set of
explicitly labeled formulas $\T_\bullet(R)$ that
$\varnothing,\ \varnothing,\ \T_\bullet(R)\dett\Box$ if and only if
there is no derivation from $\varnothing,\ \varnothing,\ \varnothing,\ R\pos\Box$ that get stuck
in a saturated state.

$\pos$ adds $\atom(L)$ to the set of encountered axioms whenever $L$ is assumed. We would like to
keep this semantics, which means that a clause $A_1\vee\neg A_2$ should be labeled as
$\langle A_1\rangle A_1\vee\langle A_2\rangle\neg A_2=\langle A_1\rangle A_1\vee\neg [A_2]A_2$.
We define an explicitely labeled formula $F'$ inductively over the form of $F$. This definition
depends on the polarity of $F$, so that a positive occurance of atom $A$ is labelled by
$\langle A\rangle A$ and a negative occurance of $A$ by $[A]A$. In the rules below,
$T_\bullet(F)$ (resp. $T_\circ(F)$) is the translation of a positive (resp.
negative) occurence of $F$. $\T$ denotes either $\T_\circ$ or $\T_\bullet$.
\begin{itemize}
 \item $\T_\bullet(A)=\langle A\rangle A$,
 \item $\T_\circ(A)=[A]A$,
 \item $\T([a]F)=[a]\T(F)$,
 \item $\T(\langle a\rangle F)=\langle a\rangle\T(F)$,
 \item $\T(F_1\wedge F_2)=\T(F_1)\wedge\T(F_2)$,
 \item $\T(F_1\vee F_2)=\T(F_1)\vee\T(F_2)$,
 \item $\T_\bullet(\neg F)= \neg\T_\circ(F)$,
 \item $\T_\circ(\neg F)= \neg\T_\bullet(F)$.
\end{itemize}
It is easy to check that whenever $F_1\Leftrightarrow F_2$, $\T(F_1)\Leftrightarrow \T(F_2)$.

\paragraph{Proof :}

\end{document}
